{% extends "base.html" %}
{% block content %}
<style>
  .tide-container{max-width:1300px;margin:24px auto;padding:0 12px}
  .tide-card{background:#fff;border-radius:18px;box-shadow:0 4px 18px rgba(0,0,0,.08);padding:28px;margin-bottom:28px}
  .tide-title{font-size:22px;font-weight:700;margin:0 0 18px;color:#1f2937}
  .tide-form{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end}
  .tide-form .form-group{flex:1;min-width:180px}
  .form-group label{display:block;font-size:18px;font-weight:700;color:#374151;margin-bottom:6px}
  /* Reuse register form-control, but larger for weather */
  .tide-form .form-control{width:100%;padding:12px 16px;border:1px solid #d1d5db;border-radius:8px;font-size:18px;box-sizing:border-box;outline:none}
  .tide-form .form-control:focus{outline:none;border-color:#0d9488;box-shadow:0 0 0 1px #0d9488}
  .tide-form select.form-control{appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");background-position:right 12px center;background-repeat:no-repeat;background-size:16px;outline:none}
  .tide-form select.form-control:focus{outline:none;border:1px solid #0d9488}
  .btn-fetch{padding:14px 32px;background:#0d9488;color:#fff;font-weight:700;font-size:18px;border:none;border-radius:8px;cursor:pointer}
  .btn-fetch:hover{background:#0f766e}
  .result-header{background:linear-gradient(135deg,#06b6d4 0%,#0e7490 100%);color:#fff;padding:15px 0;border-radius:18px 18px 0 0;text-align:center;width:1300px;margin:0 auto}
  .result-header h2{margin:0;font-size:22px;font-weight:700}
  .result-header p{display:none;margin:0;font-size:13px;opacity:.9}
  table{width:100%;border-collapse:collapse}
  thead th{background:#f9fafb;padding:14px 10px;font-size:16px;font-weight:600;color:#374151;border-bottom:2px solid #e5e7eb;text-align:center;letter-spacing:.5px}
  tbody td{padding:14px 10px;border-bottom:1px solid #f3f4f6;font-size:15px;color:#4b5563;text-align:center}
  tbody tr:nth-child(even){background:#f9fafb}
  tbody tr:hover{background:#f3f4f6}
  .time-cell{font-weight:600;color:#111827;font-size:15px}
  .status-box{margin-top:4px;font-size:11px;color:#6b7280}
  .loading-row td{padding:42px;font-size:14px;color:#6b7280}
  .empty-row td{padding:42px;font-size:14px;color:#9ca3af}
  .note{margin-top:10px;font-size:12px;color:#64748b}

  /* Flatpickr sizing + Korean style tweaks */
  .fp-wrap{position:relative;display:flex;align-items:center;gap:8px}
  .calendar-btn{display:inline-flex;align-items:center;justify-content:center;width:48px;height:48px;border:1px solid #d1d5db;border-radius:8px;background:#fff;cursor:pointer}
  .calendar-btn svg{width:28px;height:28px;color:#374151}
  .date-input{height:48px}
  .flatpickr-calendar{font-size:16px}
  .flatpickr-months .flatpickr-month{height:48px}
  .flatpickr-day{width:42px;height:36px;line-height:36px}

  /* ê²°ê³¼ 2ì—´ ë ˆì´ì•„ì›ƒ */
  .result-split{display:flex;gap:16px;background:#fff;border-radius:0 0 18px 18px;box-shadow:0 4px 18px rgba(0,0,0,.08);overflow:hidden;width:1300px;margin:0 auto;min-height:800px}
  .result-left{flex:1;min-width:0;border-right:1px solid #eef2f7;overflow:visible}
  .result-right{flex:1;min-width:0;background:#fff;overflow:visible}
  .graph-frame{display:block;width:100%;height:800px;border:0;background:#0b1320}
  .graph-panel{padding:8px;background:#fff;height:800px;overflow:visible}

  @media (max-width: 1024px){
    .result-split{flex-direction:column}
    .result-right{flex:1;min-width:0;max-width:none}
    .graph-frame{height:520px}
  }
</style>

<div class="tide-container">
  <div class="tide-card">
    <h2 class="tide-title">ğŸŒŠ ë°”ë‹¤ í•­êµ¬ ë‚ ì”¨ ì¡°íšŒ</h2>
    <form id="tide-form" class="tide-form">
      <div class="form-group">
        <label class="form-label" for="city">ì§€ì—­ ì„ íƒ</label>
        <select id="city" class="form-control" required>
          <option value="">ì§€ì—­ ì„ íƒ</option>
          {% for city in city_port_mapping.keys() %}
            <option value="{{ city }}">{{ city }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="port">í•­êµ¬ ì„ íƒ</label>
        <select id="port" class="form-control" required disabled>
          <option value="">ì§€ì—­ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="date">ë‚ ì§œ</label>
        <div class="fp-wrap">
          <input id="date" class="form-control date-input" type="text" placeholder="YYYY-MM-DD" required />
          <button type="button" id="open-cal" class="calendar-btn" aria-label="ë‹¬ë ¥ ì—´ê¸°">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2"></rect>
              <path d="M16 2v4M8 2v4M3 10h18"></path>
            </svg>
          </button>
        </div>
      </div>
      <button type="submit" class="btn-fetch">ì¡°íšŒ</button>
    </form>
    <p class="note">â€» ë°”ë‹¤íƒ€ì„ week_containerë¥¼ íŒŒì‹±í•˜ì—¬ ì‹œê°„í‘œë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤. í•­êµ¬ë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ port_idë¥¼ ë§¤í•‘í•˜ì—¬ ì¡°íšŒí•©ë‹ˆë‹¤.</p>
  </div>

  <div id="tide-result" style="display:none;position:relative;left:50%;transform:translateX(-50%);width:1300px;">
    <div class="result-header">
      <h2 id="result-title">í•­êµ¬ ë²ˆí˜¸ -</h2>
      <p id="result-sub">ì›ë³¸: -</p>
    </div>
    <div class="result-split">
      <div class="result-left">
        <table id="tide-table">
          <thead>
            <tr>
              <th>ì‹œê°„</th>
              <th>í’í–¥</th>
              <th>í’ì†</th>
              <th>ë‚ ì”¨</th>
              <th>ê¸°ì˜¨</th>
              <th>íŒŒê³ /ì£¼ê¸°</th>
            </tr>
          </thead>
          <tbody id="tide-tbody">
            <tr class="loading-row"><td colspan="6">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="result-right">
        <div id="graph-panel" class="graph-panel"></div>
      </div>
    </div>
  </div>
</div>

<!-- Flatpickr CDN (modern datepicker) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/ko.js"></script>

<!-- amCharts v4 (for tide graph rendering) -->
<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
<script src="https://cdn.amcharts.com/lib/4/lang/ko_KR.js"></script>

<script>
// í…œí”Œë¦¿ ë°ì´í„°
const CITY_PORTS = {{ city_port_mapping | tojson | safe }};
const BADA_PORT_IDS = {{ bada_port_ids | tojson | safe }};

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('tide-form');
  const tbody = document.getElementById('tide-tbody');
  const resultWrap = document.getElementById('tide-result');
  const titleEl = document.getElementById('result-title');
  const subEl = document.getElementById('result-sub');
  const dateEl = document.getElementById('date');
  const openBtn = document.getElementById('open-cal');
  const graphPanel = document.getElementById('graph-panel');

  // Flatpickr init: yyyy-mm-dd, Korean weekdays, today default
  const fp = flatpickr(dateEl, {
    dateFormat: 'Y-m-d',
    defaultDate: new Date(),
    locale: flatpickr.l10ns.ko,
    allowInput: true,
    disableMobile: true
  });
  openBtn.addEventListener('click', () => fp.open());

  // ì§€ì—­ ë³€ê²½ ì‹œ í•­êµ¬ ëª©ë¡ ì±„ìš°ê¸°
  const citySel = document.getElementById('city');
  const portSel = document.getElementById('port');
  citySel.addEventListener('change', () => {
    const city = citySel.value;
    portSel.innerHTML = '';
    if (city && CITY_PORTS[city]) {
      portSel.disabled = false;
      CITY_PORTS[city].forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        portSel.appendChild(opt);
      });
    } else {
      portSel.disabled = true;
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'ì§€ì—­ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”';
      portSel.appendChild(opt);
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const portName = portSel.value;
    if(!portName){
      alert('í•­êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    const portId = BADA_PORT_IDS[portName];
    if(!portId){
      alert('ì„ íƒí•œ í•­êµ¬ì˜ badatime IDê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    const dateStr = dateEl.value; // YYYY-MM-DD
    resultWrap.style.display = 'block';
    titleEl.textContent = `${portName} (${dateStr})`;
    subEl.textContent = dateStr || 'ìš”ì²­ ì¤‘...';
    tbody.innerHTML = '<tr class="loading-row"><td colspan="6">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
    try {
      const qs = new URLSearchParams({ port_id: String(portId), date: dateStr || '' });
      const resp = await fetch(`/api/tide?${qs.toString()}`);
      if(!resp.ok) throw new Error('10ì¼ ì´í›„ ë‚ ì”¨ëŠ” ì¡°íšŒë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      const data = await resp.json();
      if(data.error){
        throw new Error(data.error);
      }
      // ë¶€ì œëª©: ë‚ ì§œ + tide ì›ë³¸ ë§í¬
      const tideUrl = `https://www.badatime.com/${portId}/tide/${dateStr}`;
      subEl.innerHTML = `${dateStr} Â· <a href="${tideUrl}" target="_blank" rel="noopener">${tideUrl}</a>`;
      // ìš°ì¸¡ ê·¸ë˜í”„: íŒŒì‹± API í˜¸ì¶œë¡œ í•„ìš”í•œ ë¶€ë¶„ë§Œ ë¡œë“œ
      try {
        const gresp = await fetch(`/api/tide_graph?port_id=${portId}&date=${encodeURIComponent(dateStr)}`);
        if (!gresp.ok) throw new Error('ê·¸ë˜í”„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        const gdata = await gresp.json();
        if (!gdata.success) throw new Error(gdata.message || 'ê·¸ë˜í”„ íŒŒì‹± ì‹¤íŒ¨');
        graphPanel.innerHTML = (gdata.pc_html || '') + (gdata.chart_html || '');
        if (gdata.script) {
          const se = document.createElement('script');
          se.type = 'text/javascript';
          se.text = gdata.script;
          graphPanel.appendChild(se);
        }
      } catch (e) {
        graphPanel.innerHTML = `<div style="padding:12px;color:#374151;background:#fff;">ê·¸ë˜í”„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆ íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</div>`;
      }
      renderTideRows(data.data || []);
    } catch(err){
      console.error(err);
      tbody.innerHTML = `<tr class='empty-row'><td colspan='6'>${err.message}</td></tr>`;
      subEl.textContent = dateStr || '';
    }
  });

  function renderTideRows(rows){
    tbody.innerHTML = '';
    if(!rows.length){
      tbody.innerHTML = '<tr class="empty-row"><td colspan="6">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      return;
    }
    rows.forEach(r => {
      const tr = document.createElement('tr');
      const weatherDisplay = r.weather_icon_url ? `<img src='${r.weather_icon_url}' alt='' width='28' style='vertical-align:middle;margin-right:4px;'>${r.weather_text||''}` : (r.weather_text||'');
      const windDirDisplay = r.wind_dir_icon_url ? `<img src='${r.wind_dir_icon_url}' alt='' width='16' style='vertical-align:middle;margin-right:4px;'>${r.wind_dir||''}` : (r.wind_dir||'');
      
      // í’ì† ìƒ‰ìƒ ì²˜ë¦¬
      let windSpeedColor = '#4b5563'; // ê¸°ë³¸ ìƒ‰ìƒ
      const windSpeed = parseFloat(r.wind_speed || '0');
      if (windSpeed >= 5.0 && windSpeed <= 7.9) {
        windSpeedColor = '#f1c40f';
      } else if (windSpeed >= 8.0 && windSpeed <= 15.0) {
        windSpeedColor = '#c0392b';
      }
      
      tr.innerHTML = `
        <td class='time-cell'>${r.time || ''}</td>
        <td>${windDirDisplay}</td>
        <td style='color:${windSpeedColor}'>${r.wind_speed || ''}</td>
        <td>${weatherDisplay}</td>
        <td>${r.temperature || ''}</td>
        <td>${r.wave_height || ''}</td>`;
      tbody.appendChild(tr);
    });
  }
});
</script>
{% endblock %}
