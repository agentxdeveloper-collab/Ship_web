{% extends "base.html" %}
{% block content %}

<style>
  /* í†µí•© í•„í„° ì¹´ë“œ ìŠ¤íƒ€ì¼ */
  .filter-card {
    background: #f0fdf4;
    border-radius: 20px;
    padding: 30px;
    margin: 20px auto;
    max-width: 1400px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  }

  /* í—¤ë” ì„¹ì…˜ */
  .header-section {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }

  .header-section .header-icon {
    width: 48px;
    height: 48px;
    background: #10b981;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
  }

  .header-section h2 {
    color: #1f2937;
    font-size: 28px;
    font-weight: 700;
    margin: 0;
  }

  /* ë‚ ì§œ ì…ë ¥ í¬ê¸° */
  .date-input {
    font-size: 25px;
    padding: 7px 11px;
    width: 90%;
    max-width: 250px;
    text-align: center;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    transition: all 0.2s ease;
  }
  
  .date-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  /* ì¡°íšŒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .btn-search {
    padding: 9px 25px;
    font-size: 20px;
    font-weight: 600;
    color: white;
    background: #3b82f6;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-search:hover {
    background: #2563eb;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
  }

  .btn-search:active {
    transform: translateY(0);
  }
  /* ì§€ì—­ ì„ íƒ pill ìŠ¤íƒ€ì¼ */
  .region-filter label {
    position: relative;
    cursor: pointer;
  }

  .region-filter input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .region-filter label span {
    display: inline-block;
    padding-top: 5px;
    padding-bottom: 7px;
    padding-left: 10px;
    padding-right: 10px;
    border: 2px solid #e5e7eb;
    border-radius: 50px;
    background: white;
    color: #6b7280;
    font-size: 15px;
    font-weight: 500;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .region-filter label:hover span {
    border-color: #d1d5db;
    transform: translateY(-1px);
  }

  .region-filter input[type="checkbox"]:checked + span {
    background: #10b981;
    border-color: #10b981;
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }

  .status-open { color:#ff0000; font-weight:700; }
  .status-closed { color:#000000; font-weight:700; }

  /* Spinner */
  @keyframes spin { to { transform: rotate(360deg); } }
  #loading-overlay{
    display:none; position:fixed; inset:0; z-index:9999;
    background:rgba(255,255,255,0.85);
    align-items:center; justify-content:center;
  }
  #loading-overlay .spinner{
    width:56px; height:56px; border:6px solid #e5e7eb;
    border-top-color:#0366a6; border-radius:50%;
    animation:spin 1s linear infinite; margin:0 auto 14px;
  }
  #loading-overlay .msg{
    font-size:18px; color:#0366a6; font-weight:700; text-align:center;
  }

  /* ì •ë ¬ ì•„ì´ì½˜ ë²„íŠ¼ ê³µí†µ */
  .sort-icon {
    border: 0; background: transparent; padding: 0 4px; margin-left: 6px;
    cursor: pointer; color: #6b7280; font-size: 14px; line-height: 1;
  }
  .sort-icon:hover { color: #374151; }
  .sort-icon i { pointer-events: none; }

  /* ì•„ì´ì½˜ í´ë°±(ë¶€íŠ¸ìŠ¤íŠ¸ë© ì•„ì´ì½˜ ë¯¸ì‚¬ìš© ì‹œ) */
  .sort-icon[data-fallback="up"]::after { content: 'â–²'; }
  .sort-icon[data-fallback="down"]::after { content: 'â–¼'; }

  /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
  .results-section {
    max-width: 1300px;
    width:100%;
    margin: 30px auto;
    padding:0 12px;
    box-sizing:border-box;
  }

  .results-title {
    font-size: 20px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 16px;
  }

  .table-wrapper {
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    overflow-x: auto;
  }

  #results-table {
    width: 100%;
    min-width: 900px;
    border-collapse: collapse;
  }
  
  @media (max-width:768px){
    .results-section { padding:0 8px; }
    .table-wrapper { padding:12px; border-radius:12px; overflow:visible; }
    #results-table { min-width:0; }
    #results-table thead { display:none; }
    #results-table tr {
      display:block;
      margin:14px 0 18px;
      border:1px solid #e5e7eb;
      border-radius:14px;
      background:#fff;
      padding:10px 10px 4px;
      box-shadow:0 2px 6px rgba(0,0,0,0.04);
    }
    #results-table td {
      display:flex;
      align-items:flex-start;
      gap:8px;
      border:0!important;
      padding:5px 4px;
      position:relative;
      width:100%;
      box-sizing:border-box;
    }
    #results-table td:before {
      content:attr(data-label);
      flex:0 0 90px;
      font-weight:600;
      color:#374151;
      font-size:13px;
    }
    #results-table td span.status-badge { margin-top:2px; }
    .status-badge { font-size:12px; padding:4px 12px; }
    .btn-popup { min-width:100px; padding:8px 10px; font-size:13px; }
  }

  #results-table thead th {
    background: #f9fafb;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
    font-size: 14px;
    white-space: nowrap;
  }

  #results-table tbody td {
    padding: 5px;
    border-bottom: 1px solid #f3f4f6;
    font-size: 14px;
    color: #4b5563;
  }

  #results-table tbody tr:nth-child(even) {
    background-color: #f9fafb;
  }

  #results-table tbody tr:nth-child(odd) {
    background-color: #ffffff;
  }

  #results-table tbody tr:hover {
    background-color: #f3f4f6 !important;
  }

  #results-table tbody tr:last-child td {
    border-bottom: none;
  }

  .status-badge {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
  }
  
  .badge-available {
    background-color: #fee2e2;
    color: #dc2626;
  }
  
  .badge-closed {
    background-color: #4b5563;
    color: #ffffff;
  }
  
  .badge-maintenance {
    background-color: #f3f4f6;
    color: #6b7280;
  }

  /* íŒì—… ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .btn-popup {
    padding: 6px 12px;
    background: #0d9488;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-popup:hover {
    background: #0f766e;
  }

  /* íŒì—… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  .weather-popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    overflow: auto;
  }

  .popup-content {
    position: relative;
    margin: 32px auto;
    max-width: 96vw;
    width: 1200px;
    background: white;
    border-radius: 18px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    max-height: 92vh;
    overflow: visible;
  }
  
  @media (max-width:768px){
    .popup-content{max-width:98vw;margin:16px auto;border-radius:12px}
    .popup-header{padding:14px;border-radius:12px 12px 0 0}
    .popup-header h3{font-size:18px}
    .result-split{flex-direction:column;padding:6px}
    .result-left{border-right:0;border-bottom:1px solid #eef2f7}
    #tide-table thead{display:none}
    #tide-table,#tide-table tbody,#tide-table tr,#tide-table td{display:block;width:100%}
    #tide-table tr{margin-bottom:10px;border:1px solid #e5e7eb;border-radius:6px;padding:8px;background:#fff}
    #tide-table td{border:0!important;padding:6px 0;text-align:left!important;position:relative;padding-left:90px}
    #tide-table td:before{content:attr(data-label);position:absolute;left:0;width:80px;font-weight:600;color:#374151;font-size:12px}
    .graph-panel{height:auto;min-height:300px}
  }

  .popup-header {
    background: linear-gradient(135deg,#06b6d4 0%,#0e7490 100%);
    color: white;
    padding: 20px;
    border-radius: 18px 18px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .popup-header h3 {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
  }

  .popup-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .popup-body {
    padding: 0;
    max-height: none;
    overflow: visible;
  }

  /* weather.htmlê³¼ ë™ì¼í•œ íŒì—… ë‚´ë¶€ ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ */
  .result-split{display:flex;gap:16px;background:#fff;border-radius:0 0 18px 18px;box-shadow:0 4px 18px rgba(0,0,0,.08);overflow:hidden;width:1300px;margin:0 auto;min-height:800px}
  .result-left{flex:1;min-width:0;border-right:1px solid #eef2f7;overflow:visible}
  .result-right{flex:1;min-width:0;background:#fff;overflow:visible}
  .graph-panel{padding:8px;background:#fff;height:800px;overflow:visible}
  /* tide í…Œì´ë¸” ì „ìš© ìŠ¤íƒ€ì¼ (ë²”ìœ„ ì¢í˜) */
  #tide-table{width:100%;border-collapse:collapse}
  #tide-table thead th{background:#f9fafb;padding:14px 10px;font-size:16px;font-weight:600;color:#374151;border-bottom:2px solid #e5e7eb;text-align:center;letter-spacing:.5px}
  #tide-table tbody td{padding:14px 10px;border-bottom:1px solid #f3f4f6;font-size:15px;color:#4b5563;text-align:center}
  #tide-table tbody tr:nth-child(even){background:#f9fafb}
  #tide-table tbody tr:hover{background:#f3f4f6}
  .time-cell{font-weight:600;color:#111827;font-size:15px}

  /* íŒì—… í­ë„ weather ë ˆì´ì•„ì›ƒê³¼ ì¼ì¹˜ */
  .popup-content{width:1300px}

  /* Flatpickr ë‚ ì§œ ì…ë ¥ ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼ (weather.htmlê³¼ ìœ ì‚¬) */
  .fp-wrap{position:relative;display:flex;align-items:center;gap:8px}
  .calendar-btn{display:inline-flex;align-items:center;justify-content:center;width:48px;height:48px;border:1px solid #d1d5db;border-radius:8px;background:#fff;cursor:pointer}
  .calendar-btn svg{width:28px;height:28px;color:#374151}
  .form-control{width:100%;padding:12px 16px;border:1px solid #d1d5db;border-radius:8px;font-size:22px;box-sizing:border-box;outline:none}
  .form-control:focus{outline:none;border-color:#0d9488;box-sã„´hadow:0 0 0 1px #0d9488}
  .date-input{height:48px}

  /* ë‚ ì§œ í–‰ ë°˜ì‘í˜• ì •ë¦¬ */
  .date-row{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap}
  .date-row .date-col{flex:1 1 280px;min-width:0}
  .date-row .fp-wrap{width:100%}
  @media (max-width:768px){
    .date-row{align-items:center;flex-wrap:nowrap}
    .date-row .date-col{flex:0 0 auto}
    .date-row .date-col label{display:block;font-size:16px;margin-bottom:4px}
    .form-control{font-size:18px;width:160px}
    .calendar-btn{width:40px;height:40px}
    .btn-search{flex:0 0 auto;height:44px;padding:0 18px;white-space:nowrap;margin-left:8px}
  }
</style>

<!-- í†µí•© í•„í„° ì¹´ë“œ -->
<div class="filter-card">
  <form id="status-form" method="get" action="{{ url_for('views.status') }}">
    {{ form.csrf_token }}

    <!-- í—¤ë” ì„¹ì…˜ -->
    <div class="header-section">
      <div class="header-icon">ğŸ“…</div>
      <h2>ì˜ˆì•½ í˜„í™© ì¡°íšŒ</h2>
    </div>

    <!-- ì§€ì—­ ì„ íƒ ë¼ë²¨ -->
    <div style="margin-bottom: 12px;">
      <label style="font-size: 14px; font-weight: 600; color: #374151;">ì§€ì—­ ì„ íƒ</label>
    </div>

    <!-- ì§€ì—­ ì²´í¬ë°•ìŠ¤ -->
    <div class="region-filter" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 8px;">
      <label>
        <input type="checkbox" name="regions" value="ì „ì²´"
          {{ 'checked' if ('ì „ì²´' in (selected_regions or [])) else '' }}
          data-count="{{ total_registered or 0 }}">
        <span>ì „ì²´({{ total_registered or 0 }})</span>
      </label>
      {% for region in region_names %}
        <label>
          <input type="checkbox" name="regions" value="{{ region }}"
            {{ 'checked' if (region in (selected_regions or [])) else '' }}
            data-count="{{ region_counts.get(region, 0) }}">
          <span>{{ region }}({{ region_counts.get(region, 0) }})</span>
        </label>
      {% endfor %}
    </div>

    <!-- ë‚ ì§œ ì…ë ¥: Flatpickr ë‹¨ì¼ ì»´í¬ë„ŒíŠ¸ (ê°„ê²© ì¶•ì†Œ) -->
    <div class="date-row">
      <div class="date-col">
        <label style="display:block; font-size:20px; font-weight:600; color:#6b7280; margin-bottom:8px;" for="date">ë‚ ì§œì„ íƒ</label>
        <div class="fp-wrap">
          <input id="date" class="form-control date-input flatpickr-input" type="text" placeholder="YYYY-MM-DD" required style="padding-top:5px; padding-bottom:5px;">
          <button type="button" id="open-cal" class="calendar-btn" aria-label="ë‹¬ë ¥ ì—´ê¸°">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2"></rect>
              <path d="M16 2v4M8 2v4M3 10h18"></path>
            </svg>
          </button>
        </div>
      </div>
      <div style="flex:0 0 auto;padding-top: 30px;">
        <button id="searchBtn" type="submit" class="btn-search">ğŸ” ì¡°íšŒ</button>
      </div>
    </div>
    <!-- ì„œë²„ ë¼ìš°íŠ¸ í˜¸í™˜ì„ ìœ„í•œ hidden í•„ë“œ -->
    <input type="hidden" id="year" name="year" value="{{ year or '' }}">
    <input type="hidden" id="month" name="month" value="{{ month or '' }}">
    <input type="hidden" id="day" name="day" value="{{ day or '' }}">
  </form>
</div>

<!-- Spinner Overlay -->
<div id="loading-overlay">
  <div>
    <div class="spinner"></div>
    <div class="msg">ë°ì´í„° ì¡°íšŒ ì¤‘...</div>
  </div>
</div>

<!-- ì¡°íšŒ ê²°ê³¼ ì„¹ì…˜ -->
<div class="results-section">
  <h3 class="results-title">ì¡°íšŒ ê²°ê³¼ (ì‹¤ì‹œê°„)</h3>
  
  <div class="table-wrapper">
    <table id="results-table">
      <thead>
        <tr>
          <th style="width: 60px;">
            ì§€ì—­
            <button type="button" class="sort-btn sort-icon" data-sort-key="city" data-dir="asc">â–²â–¼</button>
          </th>
          <th style="width: 70px;">
            í•­êµ¬
            <button type="button" class="sort-btn sort-icon" data-sort-key="port" data-dir="asc">â–²â–¼</button>
          </th>
          <th style="width: 100px;">
            ë“±ë¡ëœ ë°°
            <button type="button" class="sort-btn sort-icon" data-sort-key="registered_name" data-dir="asc">â–²â–¼</button>
          </th>
          <th style="width: 200px;">
            ì–´ì¢…
            <button type="button" class="sort-btn sort-icon" data-sort-key="fish" data-dir="asc">â–²â–¼</button>
          </th>
          <th style="width: 200px;">
            ë°° ì´ë¦„
            <button type="button" class="sort-btn sort-icon" data-sort-key="ship_name" data-dir="asc">â–²â–¼</button>
          </th>
          <th style="width: 120px; text-align: center;">
            ìƒíƒœ
            <button type="button" class="sort-btn sort-icon" data-sort-key="status" data-dir="asc">â–²â–¼</button>
          </th>
          <th style="width: 100px; text-align: center;">
            ë‚¨ì€ìë¦¬
            <button type="button" class="sort-btn sort-icon" data-sort-key="available" data-dir="asc">â–²â–¼</button>
          </th>
          <th style="width: 92px;">
            URL
          </th>
          <th style="width: 120px; text-align: center;">
            ë‚ ì”¨/ë¬¼ë•Œ
          </th>
        </tr>
      </thead>
      <tbody id="results-body">
      {% if entries and entries|length > 0 %}
        {% for entry in entries %}
          {% set is_open = (entry.status == 'open') %}
          {% set is_closed = (entry.status in ['full','reserved']) %}
          {% set show_status =
              'ì˜ˆì•½ê°€ëŠ¥' if is_open
              else ('ì˜ˆì•½ë§ˆê°' if is_closed else ('ì ê²€ì¼' if entry.status == 'maintenance' else (entry.display_status or entry.status or 'ì•Œ ìˆ˜ ì—†ìŒ'))) %}
          <tr>
            <td data-label="ì§€ì—­">{{ entry.city or '-' }}</td>
            <td data-label="í•­êµ¬">{{ entry.port or '-' }}</td>
            <td data-label="ë“±ë¡ëœ ë°°">{{ entry.registered_name or '-' }}</td>
            <td data-label="ì–´ì¢…">{{ entry.fish or '-' }}</td>
            <td data-label="ë°° ì´ë¦„" style="font-weight: 600;">{{ entry.ship_name or '-' }} {% if entry.tide %}({{ entry.tide }}){% endif %}</td>
            <td data-label="ìƒíƒœ">
              <span class="status-badge {{ 'badge-available' if is_open else 'badge-closed' if is_closed else 'badge-maintenance' }}">
                {{ show_status }}
              </span>
            </td>
            <td data-label="ë‚¨ì€ìë¦¬">
              {{ 0 if is_closed else (entry.available if entry.available is not none else '-') }}
            </td>
            <td data-label="URL">
              {% if entry.url %}
                <a href="{{ entry.url }}" target="_blank" rel="noopener noreferrer" style="color: #3b82f6; text-decoration: none;">
                  URL ë§í¬
                </a>
              {% else %}
                -
              {% endif %}
            </td>
            <td data-label="ë‚ ì”¨/ë¬¼ë•Œ" >
              <button type="button" class="btn-popup" data-city="{{ entry.city or '' }}" data-port="{{ entry.port or '' }}" data-date="{{ year }}-{{ '%02d'|format(month) }}-{{ '%02d'|format(day) }}">
                íŒì—… ë³´ê¸°
              </button>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="9" style="padding: 40px; text-align: center; color: #9ca3af;">
            ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ì—ì„œ ì§€ì—­ê³¼ ë‚ ì§œë¥¼ ì„ íƒ í›„ ì¡°íšŒí•˜ì„¸ìš”.
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function(){
    // Flatpickr ì´ˆê¸°í™”: yyyy-mm-dd, í•œêµ­ì–´, ê¸°ë³¸ ë‚ ì§œëŠ” í…œí”Œë¦¿ year/month/day ë˜ëŠ” ì˜¤ëŠ˜
    const dateInput = document.getElementById('date');
    const openBtn = document.getElementById('open-cal');
    let defaultDate = null;
    try {
      const yInit = "{{ year or '' }}";
      const mInit = "{{ month or '' }}";
      const dInit = "{{ day or '' }}";
      if (yInit && mInit && dInit) {
        defaultDate = `${String(yInit).padStart(4,'0')}-${String(mInit).padStart(2,'0')}-${String(dInit).padStart(2,'0')}`;
      }
    } catch (e) {}

    if (typeof flatpickr !== 'undefined' && dateInput) {
      const fp = flatpickr(dateInput, {
        dateFormat: 'Y-m-d',
        defaultDate: defaultDate || new Date(),
        locale: (window.flatpickr && window.flatpickr.l10ns && window.flatpickr.l10ns.ko) ? window.flatpickr.l10ns.ko : undefined,
        allowInput: true,
        disableMobile: true
      });
      if (openBtn) openBtn.addEventListener('click', () => fp.open());
    }
    // 'ì „ì²´' ì„ íƒ ì‹œ ë‹¤ë¥¸ ì§€ì—­ í•´ì œ, ê°œë³„ ì§€ì—­ ì„ íƒ ì‹œ 'ì „ì²´' í•´ì œ
    const allBox = document.querySelector('input[name="regions"][value="ì „ì²´"]');
    const regionBoxes = Array.from(document.querySelectorAll('input[name="regions"]')).filter(cb => cb.value !== 'ì „ì²´');
    if(allBox){
      allBox.addEventListener('change', function(){
        if(allBox.checked){ regionBoxes.forEach(cb => cb.checked = false); }
      });
      regionBoxes.forEach(cb => {
        cb.addEventListener('change', function(){
          if(cb.checked) allBox.checked = false;
          if(!regionBoxes.some(b => b.checked)) allBox.checked = true; // ëª¨ë‘ í•´ì œ ì‹œ 'ì „ì²´' ìë™ ì„ íƒ
        });
      });
    }

    // í¼ ì œì¶œ ì‹œ ìŠ¤í”¼ë„ˆ í‘œì‹œ
    const form = document.getElementById('status-form');
    const overlay = document.getElementById('loading-overlay');
    if(form && overlay){
      form.addEventListener('submit', function(e){
        // ì„ íƒëœ ë‚ ì§œë¥¼ year/month/day hidden í•„ë“œë¡œ ë¶„í•´
        const di = document.getElementById('date');
        const val = di && di.value ? di.value : '';
        if (val) {
          const [yy, mm, dd] = val.split('-');
          const yEl = document.getElementById('year');
          const mEl = document.getElementById('month');
          const dEl = document.getElementById('day');
          if (yEl) yEl.value = yy;
          if (mEl) mEl.value = mm;
          if (dEl) dEl.value = dd;
        }
        overlay.style.display = 'flex';
        const btn = form.querySelector('button[type="submit"], #searchBtn');
        if(btn){ btn.disabled = true; }
      });
    }

    // ë‚ ì”¨ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (ì „ì—­ ìŠ¤ì½”í”„ì˜ fetchWeatherDataë¥¼ ì‚¬ìš©)
    async function loadWeatherData(city, port, date, contentEl) {
      try {
        const BADA_PORT_IDS = {
          'ë‚¨í•­(ì¸ì²œí•­)': 158, 'ì—°ì•ˆë¶€ë‘': 158, 'ì˜í¥í•­': 151, 'ì˜¤ì´ë„í•­': 380,
          'ì „ê³¡í•­': 618, 'í‰íƒí•­': 149, 'ì¥ê³ í•­': 370, 'ì‚¼ê¸¸í¬í•­': 144,
          'ë§ˆê²€í¬í•­': 1400, 'ëª¨í•­í•­': 134, 'ì˜ëª©í•­': 354, 'ì‹ ì§„ë„í•­': 965,
          'ì˜¤ì²œí•­': 355, 'êµ¬ë§¤í•­': 1385, 'ëŒ€ì²œí•­': 126, 'ë¬´ì°½í¬í•­': 236,
          'ë‚¨ë‹¹í•­': 356, 'í™ì›í•­': 523, 'ë¹„ì‘í•­': 118, 'ì•¼ë¯¸ë„í•­': 348,
          'ê²©í¬í•­': 430, 'ëŒì‚°í•­': 270, 'êµ­ë™í•­': 271, 'ì†Œí˜¸í•­': 826,
          'ì‹ ì¶”í•­': 885, 'ì¢…í¬í•­': 886, 'ë…¹ë™ë°©íŒŒì œ': 443
        };
        
        const portId = BADA_PORT_IDS[port];
        if (!portId) {
          throw new Error('í•´ë‹¹ í•­êµ¬ì˜ ë°”ë‹¤íƒ€ì„ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + port);
        }
        
        const response = await fetch('/api/tide?port_id=' + portId + '&date=' + date);
        if (!response.ok) {
          throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨: ' + response.status);
        }
        
        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }
        
        // ê°„ë‹¨í•œ í…Œì´ë¸” í‘œì‹œ
        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: #f9fafb;">';
        html += '<th style="padding: 12px; border: 1px solid #e5e7eb;">ì‹œê°„</th>';
        html += '<th style="padding: 12px; border: 1px solid #e5e7eb;">í’í–¥</th>';
        html += '<th style="padding: 12px; border: 1px solid #e5e7eb;">í’ì†</th>';
        html += '<th style="padding: 12px; border: 1px solid #e5e7eb;">ë‚ ì”¨</th>';
        html += '<th style="padding: 12px; border: 1px solid #e5e7eb;">ê¸°ì˜¨</th>';
        html += '<th style="padding: 12px; border: 1px solid #e5e7eb;">íŒŒê³ </th>';
        html += '</tr></thead><tbody>';
        
        if (data.data && data.data.length > 0) {
          data.data.forEach(function(row) {
            html += '<tr>';
            html += '<td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">' + (row.time || '') + '</td>';
            html += '<td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">' + (row.wind_dir || '') + '</td>';
            html += '<td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">' + (row.wind_speed || '') + '</td>';
            html += '<td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">' + (row.weather_text || '') + '</td>';
            html += '<td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">' + (row.temperature || '') + '</td>';
            html += '<td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">' + (row.wave_height || '') + '</td>';
            html += '</tr>';
          });
        } else {
          html += '<tr><td colspan="6" style="padding: 20px; text-align: center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        
        html += '</tbody></table>';
        contentEl.innerHTML = html;
        
      } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì—ëŸ¬:', error);
        contentEl.innerHTML = '<div style="padding: 20px; color: red; text-align: center;">ì—ëŸ¬: ' + error.message + '</div>';
      }
    }

    // ====== ì •ë ¬ ë™ì‘ ë¡œì§ (í–‰ ë‹¨ìœ„ë¡œ ë³€ê²½) ======
    const tbody = document.getElementById('results-body');
    const sortBtns = document.querySelectorAll('thead .sort-btn');
    if (!tbody) return;

    function parseRows() {
      const rows = [];
      for (const tr of Array.from(tbody.querySelectorAll('tr'))) {
        const tds = tr.querySelectorAll('td');
        if (tds.length < 8) continue;

        let i = 0;
        const city = tds[i++]?.textContent.trim() || '';
        const port = tds[i++]?.textContent.trim() || '';
        const registered_name = tds[i++]?.textContent.trim() || '';
        const fish = tds[i++]?.textContent.trim() || '';
        const ship_name = tds[i++]?.textContent.trim() || '';

        const statusTd = tds[i++];
        const statusBadge = statusTd?.querySelector('.status-badge');
        const status_text = statusBadge?.textContent.trim() || statusTd?.textContent.trim() || '';
        
        let status_class = 'unknown';
        if (statusBadge) {
          if (statusBadge.classList.contains('badge-available')) status_class = 'open';
          else if (statusBadge.classList.contains('badge-closed')) status_class = 'closed';
          else if (statusBadge.classList.contains('badge-maintenance')) status_class = 'maintenance';
        }

        const availText = tds[i++]?.textContent.trim() || '';
        const available = /^\d+$/.test(availText) ? parseInt(availText, 10) : null;

        const urlTd = tds[i++];
        const a = urlTd?.querySelector('a');
        const url = a ? a.getAttribute('href') : '';
        const url_path = a ? (a.textContent || '').trim() : '';

        rows.push({
          city, port, registered_name, fish, ship_name,
          status_text, status_class, available, url, url_path
        });
      }
      return rows;
    }

    function renderRows(rows) {
      const frag = document.createDocumentFragment();
      for (const r of rows) {
        const tr = document.createElement('tr');

        // ì§€ì—­
        const tdCity = document.createElement('td');
        tdCity.setAttribute('data-label', 'ì§€ì—­');
        tdCity.textContent = r.city;
        tr.appendChild(tdCity);

        // í•­êµ¬
        const tdPort = document.createElement('td');
        tdPort.setAttribute('data-label', 'í•­êµ¬');
        tdPort.textContent = r.port;
        tr.appendChild(tdPort);

        // ë“±ë¡ëœ ë°°
        const tdRN = document.createElement('td');
        tdRN.setAttribute('data-label', 'ë“±ë¡ëœ ë°°');
        tdRN.textContent = r.registered_name || '-';
        tr.appendChild(tdRN);

        // ì–´ì¢…
        const tdFish = document.createElement('td');
        tdFish.setAttribute('data-label', 'ì–´ì¢…');
        tdFish.textContent = r.fish || '-';
        tr.appendChild(tdFish);

        // ë°° ì´ë¦„
        const tdShip = document.createElement('td');
        tdShip.setAttribute('data-label', 'ë°° ì´ë¦„');
        tdShip.style.fontWeight = '600';
        tdShip.textContent = r.ship_name || '-';
        tr.appendChild(tdShip);

        // ìƒíƒœ (badge ìŠ¤íƒ€ì¼ ì ìš©)
        const tdStatus = document.createElement('td');
        tdStatus.setAttribute('data-label', 'ìƒíƒœ');
        tdStatus.style.textAlign = 'center';
        const badge = document.createElement('span');
        badge.className = 'status-badge';
        
        if (r.status_class === 'open') {
          badge.classList.add('badge-available');
          badge.textContent = 'ì˜ˆì•½ê°€ëŠ¥';
        } else if (r.status_class === 'closed') {
          badge.classList.add('badge-closed');
          badge.textContent = 'ì˜ˆì•½ë§ˆê°';
        } else if (r.status_class === 'maintenance') {
          badge.classList.add('badge-maintenance');
          badge.textContent = 'ì ê²€ì¼';
        } else {
          badge.textContent = r.status_text || '-';
        }
        tdStatus.appendChild(badge);
        tr.appendChild(tdStatus);

        // ë‚¨ì€ìë¦¬
        const tdAvail = document.createElement('td');
        tdAvail.setAttribute('data-label', 'ë‚¨ì€ìë¦¬');
        tdAvail.style.textAlign = 'center';
        tdAvail.textContent = (r.status_class === 'closed') ? '0' : (r.available != null ? String(r.available) : '-');
        tr.appendChild(tdAvail);

        // URL
        const tdUrl = document.createElement('td');
        tdUrl.setAttribute('data-label', 'URL');
        if (r.url) {
          const link = document.createElement('a');
          link.href = r.url;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.style.cssText = 'color: #3b82f6; text-decoration: none;';
          link.textContent = 'URL ë§í¬';
          tdUrl.appendChild(link);
        } else {
          tdUrl.textContent = '-';
        }
        tr.appendChild(tdUrl);

        // ë‚ ì”¨/ë¬¼ë•Œ íŒì—…
        const tdWeather = document.createElement('td');
        tdWeather.setAttribute('data-label', 'ë‚ ì”¨/ë¬¼ë•Œ');
        tdWeather.style.textAlign = 'center';
        const popupBtn = document.createElement('button');
        popupBtn.className = 'btn-popup';
        popupBtn.textContent = 'íŒì—… ë³´ê¸°';
        popupBtn.setAttribute('data-city', r.city || '');
        popupBtn.setAttribute('data-port', r.port || '');
        
        // í˜„ì¬ ì„ íƒëœ ë‚ ì§œ (flatpickr ì…ë ¥ ê°’)
        const di2 = document.getElementById('date');
        const formattedDate = (di2 && di2.value) ? di2.value : getCurrentDate();
        
        popupBtn.setAttribute('data-date', formattedDate);
        console.log('íŒì—… ë²„íŠ¼ ìƒì„±:', { city: r.city, port: r.port, date: formattedDate }); // ë””ë²„ê¹…ìš©
        tdWeather.appendChild(popupBtn);
        tr.appendChild(tdWeather);

        frag.appendChild(tr);
      }
      tbody.innerHTML = '';
      tbody.appendChild(frag);
    }

    function compareStr(a, b) {
      return (a || '').localeCompare((b || ''), 'ko');
    }
    function statusRank(s) {
      if (s === 'open') return 0;
      if (s === 'maintenance') return 1;
      if (s === 'closed') return 2;
      return 3;
    }

    function sortRows(rows, key, dir) {
      const asc = dir === 'asc' ? 1 : -1;
      return rows.sort((r1, r2) => {

        if (key === 'status') {
          return (statusRank(r1.status_class) - statusRank(r2.status_class)) * asc;
        }
        if (['city','port','registered_name','fish','ship_name'].includes(key)) {
          return compareStr(r1[key], r2[key]) * asc;
        }
        return 0;
      });
    }

    function handleSortClick(e) {
      const btn = e.currentTarget;
      const key = btn.dataset.sortKey;
      const dir = btn.dataset.dir || 'asc';
      if (!key) return;

      const rows = parseRows();
      sortRows(rows, key, dir);
      renderRows(rows);
    }

    sortBtns.forEach(b => b.addEventListener('click', handleSortClick));
    // ====== ì •ë ¬ ë¡œì§ ë ======
  });

  // ë‚ ì”¨/ë¬¼ë•Œ íŒì—… ê´€ë ¨ í•¨ìˆ˜ë“¤
  function getCurrentDate() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function openWeatherPopup(city, port, date) {
    console.log('openWeatherPopup í˜¸ì¶œë¨:', { city, port, date }); // ë””ë²„ê¹…ìš©
    const popup = document.getElementById('weather-popup');
    const title = document.getElementById('popup-title');
    const content = document.getElementById('popup-weather-content');
    
    if (!popup) {
      console.error('íŒì—… ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!');
      return;
    }
    
    // ì´ë¯¸ íŒì—…ì´ ì—´ë ¤ìˆìœ¼ë©´ ë¬´ì‹œ
    if (popup.style.display === 'block' && content.querySelector('#popup-graph-panel')) {
      console.log('íŒì—…ì´ ì´ë¯¸ ì—´ë ¤ìˆìŒ, ë¬´ì‹œ'); // ë””ë²„ê¹…ìš©
      return;
    }
    
    title.textContent = port + ' ë‚ ì”¨/ë¬¼ë•Œ ì •ë³´ (' + date + ')';
    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">ë¡œë”© ì¤‘...</div>';
    popup.style.display = 'block';
    
    console.log('íŒì—… í‘œì‹œë¨'); // ë””ë²„ê¹…ìš©
    
    // ë°”ë‹¤íƒ€ì„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    fetchWeatherData(city, port, date, content);
  }

  function closeWeatherPopup() {
    document.getElementById('weather-popup').style.display = 'none';
  }

  async function fetchWeatherData(city, port, date, contentEl) {
    try {
      const BADA_PORT_IDS = {
        'ë‚¨í•­(ì¸ì²œí•­)': 158,'ì—°ì•ˆë¶€ë‘': 158,'ì˜í¥í•­': 151,'ì˜¤ì´ë„í•­': 380,'ì „ê³¡í•­': 618,'í‰íƒí•­': 149,'ì¥ê³ í•­': 370,'ì‚¼ê¸¸í¬í•­': 144,
        'ë§ˆê²€í¬í•­': 1400,'ëª¨í•­í•­': 134,'ì˜ëª©í•­': 354,'ì‹ ì§„ë„í•­': 965,'ì˜¤ì²œí•­': 355,'êµ¬ë§¤í•­': 1385,'ëŒ€ì²œí•­': 126,'ë¬´ì°½í¬í•­': 236,
        'ë‚¨ë‹¹í•­': 356,'í™ì›í•­': 523,'ë¹„ì‘í•­': 118,'ì•¼ë¯¸ë„í•­': 348,'ê²©í¬í•­': 430,'ëŒì‚°í•­': 270,'êµ­ë™í•­': 271,'ì†Œí˜¸í•­': 826,
        'ì‹ ì¶”í•­': 885,'ì¢…í¬í•­': 886,'ë…¹ë™ë°©íŒŒì œ': 443
      };
      console.log('íŒì—… ë°ì´í„°:', { city, port, date });
      const portId = BADA_PORT_IDS[port];
      if (!portId) {
        contentEl.innerHTML = '<div style="padding:20px;color:#ef4444;">í•­êµ¬ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + port + '</div>';
        return;
      }

      // 1) í‘œ ë°ì´í„° ì‹œë„ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
      let tideData = { data: [] };
      let tideError = null;
      try {
        const qs = new URLSearchParams({ port_id: String(portId), date });
        const resp = await fetch('/api/tide?' + qs.toString());
        if (!resp.ok) {
          // 10ì¼ ì´í›„ ì¡°íšŒ ì œí•œ ì•ˆë‚´ ë¬¸êµ¬ë¡œ í†µì¼
          tideError = '10ì¼ ì´í›„ì— ë‚ ì”¨ ì •ë³´ëŠ” ì¡°íšŒê°€ ì•ˆë©ë‹ˆë‹¤.';
        } else {
          const json = await resp.json();
            if (json.error) tideError = json.error; else tideData = json;
        }
      } catch (e) {
        tideError = 'í‘œ ìš”ì²­ ì‹¤íŒ¨: ' + e.message;
      }

      // 2) ê·¸ë˜í”„ ë°ì´í„° (í•­ìƒ ì‹œë„)
      let graphHtml = ''; let graphScript = null;
      try {
        const gresp = await fetch('/api/tide_graph?port_id=' + portId + '&date=' + encodeURIComponent(date));
        if (gresp.ok) {
          const gdata = await gresp.json();
          if (gdata.success) {
            graphHtml = (gdata.pc_html || '') + (gdata.chart_html || '');
            graphScript = gdata.script;
          }
        }
      } catch (ge) {
        console.warn('ê·¸ë˜í”„ ë¡œë“œ ì‹¤íŒ¨:', ge);
      }

      // 3) HTML êµ¬ì„±
      let resultHtml = '<div class="result-split">';
      resultHtml += ' <div class="result-left"><table id="tide-table"><thead><tr>' +
        '<th>ì‹œê°„</th><th>í’í–¥</th><th>í’ì†</th><th>ë‚ ì”¨</th><th>ê¸°ì˜¨</th><th>íŒŒê³ /ì£¼ê¸°</th>' +
        '</tr></thead><tbody id="tide-tbody">';
      if (!tideError && tideData.data && tideData.data.length) {
        tideData.data.forEach((r, idx) => {
          const weatherDisplay = r.weather_icon_url ? '<img src="' + r.weather_icon_url + '" alt="" width="28" style="vertical-align:middle;margin-right:4px;">' + (r.weather_text||'') : (r.weather_text||'');
          const windDirDisplay = r.wind_dir_icon_url ? '<img src="' + r.wind_dir_icon_url + '" alt="" width="16" style="vertical-align:middle;margin-right:4px;">' + (r.wind_dir||'') : (r.wind_dir||'');
          let windSpeedColor = '#4b5563';
          const ws = parseFloat(r.wind_speed || '0');
          if (ws >= 5 && ws <= 7.9) windSpeedColor = '#f1c40f'; else if (ws >= 8 && ws <= 15) windSpeedColor = '#c0392b';
          const bg = (idx % 2 === 0) ? '#fff' : '#f9fafb';
          resultHtml += `<tr style="background:${bg}" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='${bg}'">` +
            `<td class='time-cell' data-label='ì‹œê°„'>${r.time||''}</td><td data-label='í’í–¥'>${windDirDisplay}</td>` +
            `<td data-label='í’ì†' style='color:${windSpeedColor}'>${r.wind_speed||''}</td><td data-label='ë‚ ì”¨'>${weatherDisplay}</td>` +
            `<td data-label='ê¸°ì˜¨'>${r.temperature||''}</td><td data-label='íŒŒê³ /ì£¼ê¸°'>${r.wave_height||''}</td></tr>`;
        });
      } else {
        const msg = tideError ? `<span style='color:#dc2626'>${tideError}</span>` : 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        resultHtml += `<tr><td colspan='6' style='padding:24px;text-align:center;'>${msg}</td></tr>`;
      }
      resultHtml += '</tbody></table></div>';
      resultHtml += ' <div class="result-right"><div id="graph-panel" class="graph-panel">' +
        (graphHtml || '<div style="padding:20px;text-align:center;color:#6b7280;">ê·¸ë˜í”„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>') +
        '</div></div></div>';
      contentEl.innerHTML = resultHtml;

      // 4) ê·¸ë˜í”„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      if (graphScript) {
        setTimeout(() => {
          const gp = document.getElementById('graph-panel');
          if (gp) { const se = document.createElement('script'); se.type='text/javascript'; se.text=graphScript; gp.appendChild(se); }
        }, 60);
      }
    } catch (err) {
      contentEl.innerHTML = '<div style="padding:20px;color:#ef4444;text-align:center;">ì—ëŸ¬: ' + err.message + '</div>';
    }
  }

  // íŒì—… ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ìœ„ì„
  document.addEventListener('click', function(e) {
    console.log('í´ë¦­ ì´ë²¤íŠ¸:', e.target, 'class:', e.target.className); // ë””ë²„ê¹…ìš©
    if (e.target.classList.contains('btn-popup')) {
      e.preventDefault();
      e.stopPropagation();
      console.log('íŒì—… ë²„íŠ¼ í´ë¦­ë¨!'); // ë””ë²„ê¹…ìš©
      const city = e.target.getAttribute('data-city');
      const port = e.target.getAttribute('data-port');
      const date = e.target.getAttribute('data-date');
      console.log('íŒì—… ë°ì´í„°:', { city, port, date }); // ë””ë²„ê¹…ìš©
      openWeatherPopup(city, port, date);
    }
  });

  // ESC í‚¤ë¡œ íŒì—… ë‹«ê¸°
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeWeatherPopup();
    }
  });

  // íŒì—… ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
  document.getElementById('weather-popup').addEventListener('click', function(e) {
    if (e.target === this) {
      closeWeatherPopup();
    }
  });
</script>

<!-- ë‚ ì”¨/ë¬¼ë•Œ íŒì—… ëª¨ë‹¬ -->
<div id="weather-popup" class="weather-popup">
  <div class="popup-content">
    <div class="popup-header">
      <h3 id="popup-title">ë‚ ì”¨/ë¬¼ë•Œ ì •ë³´</h3>
      <button type="button" class="popup-close" onclick="closeWeatherPopup()">&times;</button>
    </div>
    <div class="popup-body">
      <div id="popup-weather-content">
        <div style="text-align: center; padding: 40px; color: #6b7280;">
          ë¡œë”© ì¤‘...
        </div>
      </div>
    </div>
  </div>
</div>

<!-- amCharts v4 ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ (ê·¸ë˜í”„ ë Œë”ë§ìš©) -->
<!-- Flatpickr CDN (ë‚ ì§œ ì„ íƒìš©) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/ko.js"></script>

<!-- ê·¸ë˜í”„ ë Œë”ë§ -->
<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
<script src="https://cdn.amcharts.com/lib/4/lang/ko_KR.js"></script>

{% endblock %}