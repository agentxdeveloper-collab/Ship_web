{% extends "base.html" %}
{% block content %}
<style>
  .tide-container{max-width:1300px;margin:24px auto;padding:0 12px}
  .tide-card{background:#fff;border-radius:18px;box-shadow:0 4px 18px rgba(0,0,0,.08);padding:28px;margin-bottom:28px}
  .tide-title{font-size:22px;font-weight:700;margin:0 0 18px;color:#1f2937}
  .tide-form{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end}
  .tide-form .form-group{flex:1;min-width:180px}
  .form-group label{display:block;font-size:18px;font-weight:700;color:#374151;margin-bottom:6px}
  /* Reuse register form-control, but larger for weather */
  .tide-form .form-control{width:100%;padding:12px 16px;border:1px solid #d1d5db;border-radius:8px;font-size:18px;box-sizing:border-box;outline:none}
  .tide-form .form-control:focus{outline:none;border-color:#0d9488;box-shadow:0 0 0 1px #0d9488}
  .tide-form select.form-control{appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");background-position:right 12px center;background-repeat:no-repeat;background-size:16px;outline:none}
  .tide-form select.form-control:focus{outline:none;border:1px solid #0d9488}
  .btn-fetch{padding:14px 32px;background:#0d9488;color:#fff;font-weight:700;font-size:18px;border:none;border-radius:8px;cursor:pointer}
  .btn-fetch:hover{background:#0f766e}
  .result-header{background:linear-gradient(135deg,#06b6d4 0%,#0e7490 100%);color:#fff;padding:15px 0;border-radius:18px 18px 0 0;text-align:center;width:1300px;margin:0 auto}
  .result-header h2{margin:0;font-size:22px;font-weight:700}
  .result-header p{display:none;margin:0;font-size:13px;opacity:.9}
  table{width:100%;border-collapse:collapse}
  thead th{background:#f9fafb;padding:14px 10px;font-size:16px;font-weight:600;color:#374151;border-bottom:2px solid #e5e7eb;text-align:center;letter-spacing:.5px}
  tbody td{padding:14px 10px;border-bottom:1px solid #f3f4f6;font-size:15px;color:#4b5563;text-align:center}
  tbody tr:nth-child(even){background:#f9fafb}
  tbody tr:hover{background:#f3f4f6}
  .time-cell{font-weight:600;color:#111827;font-size:15px}
  .status-box{margin-top:4px;font-size:11px;color:#6b7280}
  .loading-row td{padding:42px;font-size:14px;color:#6b7280}
  .empty-row td{padding:42px;font-size:14px;color:#9ca3af}
  .note{margin-top:10px;font-size:12px;color:#64748b}

  /* Flatpickr sizing + Korean style tweaks */
  .fp-wrap{position:relative;display:flex;align-items:center;gap:8px}
  .calendar-btn{display:inline-flex;align-items:center;justify-content:center;width:48px;height:48px;border:1px solid #d1d5db;border-radius:8px;background:#fff;cursor:pointer}
  .calendar-btn svg{width:28px;height:28px;color:#374151}
  .date-input{height:48px}
  .flatpickr-calendar{font-size:16px}
  .flatpickr-months .flatpickr-month{height:48px}
  .flatpickr-day{width:42px;height:36px;line-height:36px}

  /* ê²°ê³¼ 2ì—´ ë ˆì´ì•„ì›ƒ */
  .result-split{display:flex;gap:16px;background:#fff;border-radius:0 0 18px 18px;box-shadow:0 4px 18px rgba(0,0,0,.08);overflow:hidden;max-width:1300px;width:100%;margin:0 auto;min-height:800px;box-sizing:border-box}
  .result-left{flex:1;min-width:0;border-right:1px solid #eef2f7;overflow-x:auto}
  .result-right{flex:1;min-width:0;background:#fff;overflow:visible}
  .graph-frame{display:block;width:100%;height:800px;border:0;background:#0b1320}
  .graph-panel{padding:8px;background:#fff;height:800px;overflow:visible}
  
  /* ëª¨ë°”ì¼ ì¡°ì„ ì •ë³´ í…Œì´ë¸” */
  .mo_txt_view{display:none}
  .mo_txt_view table{width:100%;background-color:#f6f6f6;text-align:center;border:1px solid #DEDEDE;border-collapse:collapse}
  .mo_txt_view td{border:1px solid #DEDEDE;padding:12px 8px}
  .mo_txt_view td:first-child{width:30%;background-color:#f6f6f6;font-weight:600;color:#374151}
  .mo_txt_view td:last-child{width:70%;background-color:#ffffff;font-size:16px;line-height:1.6}

  @media (max-width: 1024px){
    .result-split{flex-direction:column;max-width:100%;padding:8px}
    .result-left{border-right:0;border-bottom:1px solid #eef2f7}
    .result-right{flex:1;min-width:0;max-width:none}
    .graph-frame{height:520px}
    .graph-panel{height:auto;min-height:400px;padding:4px}
    /* ëª¨ë°”ì¼ì—ì„œ ì¡°ì„ ì •ë³´ í…Œì´ë¸” í‘œì‹œ */
    .mo_txt_view{display:block;margin-bottom:16px}
    /* result-header ëª¨ë°”ì¼ ëŒ€ì‘ */
    .result-header{width:100%;max-width:100%;border-radius:12px 12px 0 0}
    #tide-result{width:100%!important;max-width:100%!important;transform:none!important;left:0!important;position:relative!important}
  }
  
  @media (max-width:768px){
    .tide-container{padding:0 8px}
    .tide-card{padding:20px 16px;border-radius:12px}
    .tide-form{flex-direction:column;gap:12px;align-items:stretch}
    .form-group{min-width:0;width:100%}
    /* ì§€ì—­/í•­êµ¬ ì„ íƒì´ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ 100% í­ ë³´ì¥ */
    .tide-form .form-group .form-control{width:100% !important;max-width:100%;box-sizing:border-box}
    .fp-wrap{width:100%}
    .date-input{width:100%}
    /* status.htmlê³¼ ë™ì¼í•œ ë‚ ì§œ í–‰ ë ˆì´ì•„ì›ƒ */
    .date-row{align-items:center;flex-wrap:nowrap}
    .date-row .date-col{flex:0 0 auto}
    .date-row .date-col label{display:block;font-size:16px;margin-bottom:4px}
    /* ë‚ ì§œ ì…ë ¥ ì „ìš© í­ (ì„ íƒë°•ìŠ¤ì—ëŠ” ì ìš©ë˜ì§€ ì•Šë„ë¡ ë²”ìœ„ í•œì •) */
    .date-row .form-control{font-size:18px;width:160px}
    .calendar-btn{width:40px;height:40px}
    /* ëª¨ë°”ì¼ì—ì„œ ë‚ ì§œ ì…ë ¥/ë‹¬ë ¥ ë²„íŠ¼ê³¼ ë™ì¼í•œ ë†’ì´(40px)ë¡œ ì •ë ¬ */
    .date-input{height:40px}
    .btn-fetch{flex:0 0 auto;height:40px;padding:0 16px;white-space:nowrap;margin-left:8px;display:inline-flex;align-items:center}
    /* tide-table ëª¨ë°”ì¼ ì¹´ë“œ ë ˆì´ì•„ì›ƒ */
    #tide-table thead{display:none}
    #tide-table,#tide-table tbody,#tide-table tr,#tide-table td{display:block;width:100%;box-sizing:border-box}
    #tide-table tbody{width:100%;overflow:visible}
    #tide-table tr{margin-bottom:12px;border:1px solid #e5e7eb;border-radius:8px;padding:10px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.05);max-width:100%;box-sizing:border-box}
    #tide-table td{border:0!important;padding:8px 4px;text-align:left!important;display:flex;align-items:flex-start;gap:8px;min-height:24px;box-sizing:border-box;max-width:100%;word-break:break-word}
    #tide-table td:before{content:attr(data-label);flex:0 0 80px;font-weight:600;color:#374151;font-size:13px;padding-top:0}
    #tide-table td img{flex-shrink:0}
    /* ë¡œë”©/ë¹ˆ í–‰ì€ flex í•´ì œ */
    #tide-table .loading-row td,#tide-table .empty-row td{display:block;text-align:center!important;padding:20px}
    #tide-table .loading-row td:before,#tide-table .empty-row td:before{display:none}
    /* ëª¨ë°”ì¼ ì¡°ì„ ì •ë³´ í…Œì´ë¸” ìŠ¤íƒ€ì¼ ê°œì„  */
    .mo_txt_view table{font-size:14px}
    .mo_txt_view td{padding:10px 8px!important}
    .mo_txt_view td:first-child{font-size:13px}
    .mo_txt_view td:last-child{font-size:15px;line-height:1.8}
    /* graph-panel SVG ëª¨ë°”ì¼ ëŒ€ì‘ */
    .graph-panel{padding:4px;overflow-x:auto}
    .graph-panel svg{max-width:100%;height:auto!important}
  }

  /* ë‚ ì§œ í–‰ ê³µí†µ ë ˆì´ì•„ì›ƒ (status.htmlê³¼ ë™ì¼, ë°ìŠ¤í¬í†±ì—ì„œë„ í•œ ì¤„ ìœ ì§€) */
  .date-row{display:flex;gap:8px;align-items:center;flex-wrap:nowrap}
  .date-row .date-col{flex:0 0 auto}
  .date-row .fp-wrap{width:auto}
  /* ë°ìŠ¤í¬í†±/íƒœë¸”ë¦¿: ë‚ ì§œ ì…ë ¥ í­ ì¶•ì†Œí•´ ì¡°íšŒ ë²„íŠ¼ì„ ì˜¤ë¥¸ìª½ì— ë°°ì¹˜ */
  .date-row .form-control{width:200px}
  .date-row .calendar-btn{width:48px;height:48px}
  .date-row .btn-fetch{height:48px;padding:0 18px;display:inline-flex;align-items:center;white-space:nowrap}
</style>

<div class="tide-container">
  <div class="tide-card">
    <h2 class="tide-title">ğŸŒŠ ë°”ë‹¤ í•­êµ¬ ë‚ ì”¨ ì¡°íšŒ</h2>
    <form id="tide-form" class="tide-form">
      <div class="form-group">
        <label class="form-label" for="city">ì§€ì—­ ì„ íƒ</label>
        <select id="city" class="form-control" required>
          <option value="">ì§€ì—­ ì„ íƒ</option>
          {% for city in city_port_mapping.keys() %}
            <option value="{{ city }}">{{ city }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="port">í•­êµ¬ ì„ íƒ</label>
        <select id="port" class="form-control" required disabled>
          <option value="">ì§€ì—­ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>
      <div class="date-row">
        <div class="date-col">
          <label class="form-label" for="date">ë‚ ì§œ</label>
          <div class="fp-wrap">
            <input id="date" class="form-control date-input flatpickr-input" type="text" placeholder="YYYY-MM-DD" required />
            <button type="button" id="open-cal" class="calendar-btn" aria-label="ë‹¬ë ¥ ì—´ê¸°">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                <path d="M16 2v4M8 2v4M3 10h18"></path>
              </svg>
            </button>
          </div>
        </div>
        <div style="flex:0 0 auto; margin-top: 27px;">
          <button type="submit" class="btn-fetch">ì¡°íšŒ</button>
        </div>
      </div>
    </form>
    <p class="note">â€» ë°”ë‹¤íƒ€ì„ week_containerë¥¼ íŒŒì‹±í•˜ì—¬ ì‹œê°„í‘œë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤. í•­êµ¬ë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ port_idë¥¼ ë§¤í•‘í•˜ì—¬ ì¡°íšŒí•©ë‹ˆë‹¤.</p>
  </div>

  <div id="tide-result" style="display:none;position:relative;left:50%;transform:translateX(-50%);width:1300px;">
    <div class="result-header">
      <h2 id="result-title">í•­êµ¬ ë²ˆí˜¸ -</h2>
      <p id="result-sub">ì›ë³¸: -</p>
    </div>
    <div class="result-split">
      <div class="result-left">
        <!-- ëª¨ë°”ì¼ ì¡°ì„ ì •ë³´ -->
        <div class="mo_txt_view"></div>
        
        <table id="tide-table">
          <thead>
            <tr>
              <th>ì‹œê°„</th>
              <th>í’í–¥</th>
              <th>í’ì†</th>
              <th>ë‚ ì”¨</th>
              <th>ê¸°ì˜¨</th>
              <th>íŒŒê³ /ì£¼ê¸°</th>
            </tr>
          </thead>
          <tbody id="tide-tbody">
            <tr class="loading-row"><td colspan="6">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="result-right">
        <div id="graph-panel" class="graph-panel"></div>
      </div>
    </div>
  </div>
</div>

<!-- Flatpickr CDN (modern datepicker) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/ko.js"></script>

<!-- amCharts v4 (for tide graph rendering) -->
<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
<script src="https://cdn.amcharts.com/lib/4/lang/ko_KR.js"></script>

<script>
// í…œí”Œë¦¿ ë°ì´í„°
const CITY_PORTS = {{ city_port_mapping | tojson | safe }};
const BADA_PORT_IDS = {{ bada_port_ids | tojson | safe }};

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('tide-form');
  const tbody = document.getElementById('tide-tbody');
  const resultWrap = document.getElementById('tide-result');
  const titleEl = document.getElementById('result-title');
  const subEl = document.getElementById('result-sub');
  const dateEl = document.getElementById('date');
  const openBtn = document.getElementById('open-cal');
  const graphPanel = document.getElementById('graph-panel');

  // Flatpickr init: yyyy-mm-dd, Korean weekdays, today default
  const fp = flatpickr(dateEl, {
    dateFormat: 'Y-m-d',
    defaultDate: new Date(),
    locale: flatpickr.l10ns.ko,
    allowInput: true,
    disableMobile: true
  });
  openBtn.addEventListener('click', () => fp.open());

  // ì§€ì—­ ë³€ê²½ ì‹œ í•­êµ¬ ëª©ë¡ ì±„ìš°ê¸°
  const citySel = document.getElementById('city');
  const portSel = document.getElementById('port');
  citySel.addEventListener('change', () => {
    const city = citySel.value;
    portSel.innerHTML = '';
    if (city && CITY_PORTS[city]) {
      portSel.disabled = false;
      CITY_PORTS[city].forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        portSel.appendChild(opt);
      });
    } else {
      portSel.disabled = true;
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'ì§€ì—­ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”';
      portSel.appendChild(opt);
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const portName = portSel.value;
    if(!portName){
      alert('í•­êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    const portId = BADA_PORT_IDS[portName];
    if(!portId){
      alert('ì„ íƒí•œ í•­êµ¬ì˜ badatime IDê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    const dateStr = dateEl.value; // YYYY-MM-DD
    resultWrap.style.display = 'block';
    titleEl.textContent = `${portName} (${dateStr})`;
    subEl.textContent = dateStr || 'ìš”ì²­ ì¤‘...';
    tbody.innerHTML = '<tr class="loading-row"><td colspan="6">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';

    let tideRows = [];
    let tideError = null;
    // 1) í‘œ ë°ì´í„° ì‹œë„
    try {
      const qs = new URLSearchParams({ port_id: String(portId), date: dateStr || '' });
      const resp = await fetch(`/api/tide?${qs.toString()}`);
      if(!resp.ok) {
        // 10ì¼ ì´í›„ ì¡°íšŒ ì œí•œ ì•ˆë‚´ ë¬¸êµ¬ë¡œ í†µì¼
        tideError = '10ì¼ ì´í›„ ë‚ ì”¨ ì •ë³´ëŠ” ì¡°íšŒê°€ ì•ˆë©ë‹ˆë‹¤.';
      } else {
        const data = await resp.json();
        if(data.error) {
          tideError = data.error;
        } else {
          tideRows = data.data || [];
        }
      }
    } catch(errTable) {
      tideError = 'í‘œ ìš”ì²­ ì‹¤íŒ¨: ' + errTable.message;
    }

    // 2) ê·¸ë˜í”„ í•­ìƒ ì‹œë„
    try {
      const gresp = await fetch(`/api/tide_graph?port_id=${portId}&date=${encodeURIComponent(dateStr)}`);
      if (!gresp.ok) throw new Error('ê·¸ë˜í”„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      const gdata = await gresp.json();
      if (!gdata.success) throw new Error(gdata.message || 'ê·¸ë˜í”„ íŒŒì‹± ì‹¤íŒ¨');
      
      // ëª¨ë°”ì¼ ì¡°ì„ ì •ë³´ í…Œì´ë¸” ë Œë”ë§
      const moView = document.querySelector('.mo_txt_view');
      if (moView && gdata.mo_html) {
        moView.innerHTML = gdata.mo_html;
      }
      
      // PC ê·¸ë˜í”„ ë Œë”ë§
      graphPanel.innerHTML = (gdata.pc_html || '') + (gdata.chart_html || '');
      if (gdata.script) {
        const se = document.createElement('script');
        se.type = 'text/javascript';
        se.text = gdata.script;
        graphPanel.appendChild(se);
      }
    } catch (eGraph) {
      graphPanel.innerHTML = `<div style="padding:12px;color:#374151;background:#fff;">ê·¸ë˜í”„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆ íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</div>`;
    }

    // 3) ë¶€ì œëª© / ì›ë³¸ ë§í¬
    const tideUrl = `https://www.badatime.com/${portId}/tide/${dateStr}`;
    subEl.innerHTML = `${dateStr} Â· <a href="${tideUrl}" target="_blank" rel="noopener">${tideUrl}</a>`;

    // 4) í‘œ ë Œë”ë§
    if (tideError) {
      tbody.innerHTML = `<tr class='empty-row'><td colspan='6'><span style='color:#dc2626'>${tideError}</span></td></tr>`;
    } else {
      renderTideRows(tideRows);
    }
  });

  function renderTideRows(rows){
    tbody.innerHTML = '';
    if(!rows.length){
      tbody.innerHTML = '<tr class="empty-row"><td colspan="6">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      return;
    }
    rows.forEach(r => {
      const tr = document.createElement('tr');
      const weatherDisplay = r.weather_icon_url ? `<img src='${r.weather_icon_url}' alt='' width='28' style='vertical-align:middle;margin-right:4px;'>${r.weather_text||''}` : (r.weather_text||'');
      const windDirDisplay = r.wind_dir_icon_url ? `<img src='${r.wind_dir_icon_url}' alt='' width='16' style='vertical-align:middle;margin-right:4px;'>${r.wind_dir||''}` : (r.wind_dir||'');
      
      // í’ì† ìƒ‰ìƒ ì²˜ë¦¬
      let windSpeedColor = '#4b5563'; // ê¸°ë³¸ ìƒ‰ìƒ
      const windSpeed = parseFloat(r.wind_speed || '0');
      if (windSpeed >= 5.0 && windSpeed <= 7.9) {
        windSpeedColor = '#f1c40f';
      } else if (windSpeed >= 8.0 && windSpeed <= 15.0) {
        windSpeedColor = '#c0392b';
      }
      
      tr.innerHTML = `
        <td class='time-cell' data-label='ì‹œê°„'>${r.time || ''}</td>
        <td data-label='í’í–¥'>${windDirDisplay}</td>
        <td data-label='í’ì†' style='color:${windSpeedColor}'>${r.wind_speed || ''}</td>
        <td data-label='ë‚ ì”¨'>${weatherDisplay}</td>
        <td data-label='ê¸°ì˜¨'>${r.temperature || ''}</td>
        <td data-label='íŒŒê³ /ì£¼ê¸°'>${r.wave_height || ''}</td>`;
      tbody.appendChild(tr);
    });
  }
});
</script>
{% endblock %}
