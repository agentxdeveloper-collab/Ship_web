{% extends "base.html" %}
{% block content %}

<style>
  /* í†µí•© í•„í„° ì¹´ë“œ ìŠ¤íƒ€ì¼ */
  .filter-card {
    background: #f0fdf4;
    border-radius: 20px;
    padding: 30px;
    margin: 20px auto;
    max-width: 1400px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  }

  /* í—¤ë” ì„¹ì…˜ */
  .header-section {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }

  .header-section .header-icon {
    width: 48px;
    height: 48px;
    background: #10b981;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
  }

  .header-section h2 {
    color: #1f2937;
    font-size: 28px;
    font-weight: 700;
    margin: 0;
  }

  /* ë‚ ì§œ ì…ë ¥ í¬ê¸° */
  .date-input {
    font-size: 25px;
    padding: 7px 11px;
    width: 90%;
    max-width: 250px;
    text-align: center;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    transition: all 0.2s ease;
  }
  
  .date-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  /* ì¡°íšŒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .btn-search {
    padding: 14px 40px;
    font-size: 18px;
    font-weight: 600;
    color: white;
    background: #3b82f6;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-search:hover {
    background: #2563eb;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
  }

  .btn-search:active {
    transform: translateY(0);
  }
  /* ì§€ì—­ ì„ íƒ pill ìŠ¤íƒ€ì¼ */
  .region-filter label {
    position: relative;
    cursor: pointer;
  }

  .region-filter input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .region-filter label span {
    display: inline-block;
    padding-top: 5px;
    padding-bottom: 7px;
    padding-left: 10px;
    padding-right: 10px;
    border: 2px solid #e5e7eb;
    border-radius: 50px;
    background: white;
    color: #6b7280;
    font-size: 15px;
    font-weight: 500;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .region-filter label:hover span {
    border-color: #d1d5db;
    transform: translateY(-1px);
  }

  .region-filter input[type="checkbox"]:checked + span {
    background: #10b981;
    border-color: #10b981;
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }

  .status-open { color:#ff0000; font-weight:700; }
  .status-closed { color:#000000; font-weight:700; }

  /* Spinner */
  @keyframes spin { to { transform: rotate(360deg); } }
  #loading-overlay{
    display:none; position:fixed; inset:0; z-index:9999;
    background:rgba(255,255,255,0.85);
    align-items:center; justify-content:center;
  }
  #loading-overlay .spinner{
    width:56px; height:56px; border:6px solid #e5e7eb;
    border-top-color:#0366a6; border-radius:50%;
    animation:spin 1s linear infinite; margin:0 auto 14px;
  }
  #loading-overlay .msg{
    font-size:18px; color:#0366a6; font-weight:700; text-align:center;
  }

  /* ì •ë ¬ ì•„ì´ì½˜ ë²„íŠ¼ ê³µí†µ */
  .sort-icon {
    border: 0; background: transparent; padding: 0 4px; margin-left: 6px;
    cursor: pointer; color: #6b7280; font-size: 14px; line-height: 1;
  }
  .sort-icon:hover { color: #374151; }
  .sort-icon i { pointer-events: none; }

  /* ì•„ì´ì½˜ í´ë°±(ë¶€íŠ¸ìŠ¤íŠ¸ë© ì•„ì´ì½˜ ë¯¸ì‚¬ìš© ì‹œ) */
  .sort-icon[data-fallback="up"]::after { content: 'â–²'; }
  .sort-icon[data-fallback="down"]::after { content: 'â–¼'; }

  /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
  .results-section {
    width: 1300px;
    margin: 30px auto;
    position: relative;
    left: 50%;
    transform: translateX(-50%);
  }

  .results-title {
    font-size: 20px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 16px;
  }

  .table-wrapper {
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    overflow-x: auto;
  }

  #results-table {
    width: 100%;
    min-width: 900px;
    border-collapse: collapse;
  }

  #results-table thead th {
    background: #f9fafb;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
    font-size: 14px;
    white-space: nowrap;
  }

  #results-table tbody td {
    padding: 12px;
    border-bottom: 1px solid #f3f4f6;
    font-size: 14px;
    color: #4b5563;
  }

  #results-table tbody tr:nth-child(even) {
    background-color: #f9fafb;
  }

  #results-table tbody tr:nth-child(odd) {
    background-color: #ffffff;
  }

  #results-table tbody tr:hover {
    background-color: #f3f4f6 !important;
  }

  #results-table tbody tr:last-child td {
    border-bottom: none;
  }

  .status-badge {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
  }
  
  .badge-available {
    background-color: #fee2e2;
    color: #dc2626;
  }
  
  .badge-closed {
    background-color: #4b5563;
    color: #ffffff;
  }
  
  .badge-maintenance {
    background-color: #f3f4f6;
    color: #6b7280;
  }

  /* íŒì—… ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .btn-popup {
    padding: 6px 12px;
    background: #0d9488;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-popup:hover {
    background: #0f766e;
  }

  /* íŒì—… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  .weather-popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    overflow-y: auto;
  }

  .popup-content {
    position: relative;
    margin: 20px auto;
    max-width: 95%;
    width: 1400px;
    background: white;
    border-radius: 18px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  }

  .popup-header {
    background: linear-gradient(135deg,#06b6d4 0%,#0e7490 100%);
    color: white;
    padding: 20px;
    border-radius: 18px 18px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .popup-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .popup-body {
    padding: 0;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
  }
</style>

<!-- í†µí•© í•„í„° ì¹´ë“œ -->
<div class="filter-card">
  <form id="status-form" method="get" action="{{ url_for('views.status') }}">
    {{ form.csrf_token }}

    <!-- í—¤ë” ì„¹ì…˜ -->
    <div class="header-section">
      <div class="header-icon">ğŸ“…</div>
      <h2>ì˜ˆì•½ í˜„í™© ì¡°íšŒ</h2>
    </div>

    <!-- ì§€ì—­ ì„ íƒ ë¼ë²¨ -->
    <div style="margin-bottom: 12px;">
      <label style="font-size: 14px; font-weight: 600; color: #374151;">ì§€ì—­ ì„ íƒ</label>
    </div>

    <!-- ì§€ì—­ ì²´í¬ë°•ìŠ¤ -->
    <div class="region-filter" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 8px;">
      <label>
        <input type="checkbox" name="regions" value="ì „ì²´"
          {{ 'checked' if ('ì „ì²´' in (selected_regions or [])) else '' }}
          data-count="{{ total_registered or 0 }}">
        <span>ì „ì²´({{ total_registered or 0 }})</span>
      </label>
      {% for region in region_names %}
        <label>
          <input type="checkbox" name="regions" value="{{ region }}"
            {{ 'checked' if (region in (selected_regions or [])) else '' }}
            data-count="{{ region_counts.get(region, 0) }}">
          <span>{{ region }}({{ region_counts.get(region, 0) }})</span>
        </label>
      {% endfor %}
    </div>

    <!-- ë‚ ì§œ ì…ë ¥ -->
    <div style="display:flex; gap:20px; flex-wrap:wrap; align-items: flex-end;">
      <div style="flex:1; min-width:180px; max-width:250px;">
        <label style="display:block; font-size:20px; font-weight:600; color:#6b7280; margin-bottom:8px;" for="year">ì—°ë„</label>
        <input id="year" name="year" type="number" class="date-input" min="2000" max="2100"
               value="{{ year or '' }}" required>
      </div>
      <div style="flex:1; min-width:180px; max-width:250px;">
        <label style="display:block; font-size:20px; font-weight:600; color:#6b7280; margin-bottom:8px;" for="month">ì›”</label>
        <input id="month" name="month" type="number" class="date-input" min="1" max="12"
               value="{{ month or '' }}" required>
      </div>
      <div style="flex:1; min-width:180px; max-width:250px;">
        <label style="display:block; font-size:20px; font-weight:600; color:#6b7280; margin-bottom:8px;" for="day">ì¼</label>
        <input id="day" name="day" type="number" class="date-input" min="1" max="31"
               value="{{ day or '' }}" required>
      </div>
      <div style="flex:0 0 auto;">
        <button id="searchBtn" type="submit" class="btn-search">
          ğŸ” ì¡°íšŒ
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Spinner Overlay -->
<div id="loading-overlay">
  <div>
    <div class="spinner"></div>
    <div class="msg">ë°ì´í„° ì¡°íšŒ ì¤‘...</div>
  </div>
</div>

<!-- ì¡°íšŒ ê²°ê³¼ ì„¹ì…˜ -->
<div class="results-section">
  <h3 class="results-title">ì¡°íšŒ ê²°ê³¼ (ì‹¤ì‹œê°„)</h3>
  
  <div class="table-wrapper">
    <table id="results-table">
      <thead>
        <tr>
          <th style="width: 60px;">
            ì§€ì—­
            <button type="button" class="sort-btn sort-icon" data-sort-key="city" data-dir="asc">â–²â–¼</button>
          </th>
          <th style="width: 70px;">
            í•­êµ¬
            <button type="button" class="sort-btn sort-icon" data-sort-key="port" data-dir="asc">â–²â–¼</button>
          </th>
          <th style="width: 100px;">
            ë“±ë¡ëœ ë°°
            <button type="button" class="sort-btn sort-icon" data-sort-key="registered_name" data-dir="asc">â–²â–¼</button>
          </th>
          <th style="width: 200px;">
            ì–´ì¢…
            <button type="button" class="sort-btn sort-icon" data-sort-key="fish" data-dir="asc">â–²â–¼</button>
          </th>
          <th style="width: 200px;">
            ë°° ì´ë¦„
            <button type="button" class="sort-btn sort-icon" data-sort-key="ship_name" data-dir="asc">â–²â–¼</button>
          </th>
          <th style="width: 120px; text-align: center;">
            ìƒíƒœ
            <button type="button" class="sort-btn sort-icon" data-sort-key="status" data-dir="asc">â–²â–¼</button>
          </th>
          <th style="width: 100px; text-align: center;">
            ë‚¨ì€ìë¦¬
            <button type="button" class="sort-btn sort-icon" data-sort-key="available" data-dir="asc">â–²â–¼</button>
          </th>
          <th style="width: 92px;">
            URL
          </th>
          <th style="width: 120px; text-align: center;">
            ë‚ ì”¨/ë¬¼ë•Œ
          </th>
        </tr>
      </thead>
      <tbody id="results-body">
      {% if entries and entries|length > 0 %}
        {% for entry in entries %}
          {% set is_open = (entry.status == 'open') %}
          {% set is_closed = (entry.status in ['full','reserved']) %}
          {% set show_status =
              'ì˜ˆì•½ê°€ëŠ¥' if is_open
              else ('ì˜ˆì•½ë§ˆê°' if is_closed else ('ì ê²€ì¼' if entry.status == 'maintenance' else (entry.display_status or entry.status or 'ì•Œ ìˆ˜ ì—†ìŒ'))) %}
          <tr>
            <td>{{ entry.city or '-' }}</td>
            <td>{{ entry.port or '-' }}</td>
            <td>{{ entry.registered_name or '-' }}</td>
            <td>{{ entry.fish or '-' }}</td>
            <td style="font-weight: 600;">{{ entry.ship_name or '-' }} {% if entry.tide %}({{ entry.tide }}){% endif %}</td>
            <td style="text-align: center;">
              <span class="status-badge {{ 'badge-available' if is_open else 'badge-closed' if is_closed else 'badge-maintenance' }}">
                {{ show_status }}
              </span>
            </td>
            <td style="text-align: center;">
              {{ 0 if is_closed else (entry.available if entry.available is not none else '-') }}
            </td>
            <td>
              {% if entry.url %}
                <a href="{{ entry.url }}" target="_blank" rel="noopener noreferrer" style="color: #3b82f6; text-decoration: none;">
                  URL ë§í¬
                </a>
              {% else %}
                -
              {% endif %}
            </td>
            <td style="text-align: center;">
              <button type="button" class="btn-popup" data-city="{{ entry.city or '' }}" data-port="{{ entry.port or '' }}" data-date="{{ year }}-{{ '%02d'|format(month) }}-{{ '%02d'|format(day) }}">
                íŒì—… ë³´ê¸°
              </button>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="9" style="padding: 40px; text-align: center; color: #9ca3af;">
            ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ì—ì„œ ì§€ì—­ê³¼ ë‚ ì§œë¥¼ ì„ íƒ í›„ ì¡°íšŒí•˜ì„¸ìš”.
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function(){
    // 'ì „ì²´' ì„ íƒ ì‹œ ë‹¤ë¥¸ ì§€ì—­ í•´ì œ, ê°œë³„ ì§€ì—­ ì„ íƒ ì‹œ 'ì „ì²´' í•´ì œ
    const allBox = document.querySelector('input[name="regions"][value="ì „ì²´"]');
    const regionBoxes = Array.from(document.querySelectorAll('input[name="regions"]')).filter(cb => cb.value !== 'ì „ì²´');
    if(allBox){
      allBox.addEventListener('change', function(){
        if(allBox.checked){ regionBoxes.forEach(cb => cb.checked = false); }
      });
      regionBoxes.forEach(cb => {
        cb.addEventListener('change', function(){
          if(cb.checked) allBox.checked = false;
          if(!regionBoxes.some(b => b.checked)) allBox.checked = true; // ëª¨ë‘ í•´ì œ ì‹œ 'ì „ì²´' ìë™ ì„ íƒ
        });
      });
    }

    // í¼ ì œì¶œ ì‹œ ìŠ¤í”¼ë„ˆ í‘œì‹œ
    const form = document.getElementById('status-form');
    const overlay = document.getElementById('loading-overlay');
    if(form && overlay){
      form.addEventListener('submit', function(e){
        overlay.style.display = 'flex';
        const btn = form.querySelector('button[type="submit"], #searchBtn');
        if(btn){ btn.disabled = true; }
      });
    }

    // íŒì—… ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('btn-popup')) {
        console.log('íŒì—… ë²„íŠ¼ í´ë¦­ë¨!');
        const city = e.target.getAttribute('data-city');
        const port = e.target.getAttribute('data-port');
        const date = e.target.getAttribute('data-date');
        
        console.log('íŒì—… ë°ì´í„°:', { city, port, date });
        
        const popup = document.getElementById('weather-popup');
        const title = document.getElementById('popup-title');
        const content = document.getElementById('popup-weather-content');
        
        if (popup && title && content) {
          title.textContent = port + ' ë‚ ì”¨/ë¬¼ë•Œ ì •ë³´ (' + date + ')';
          content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">ë¡œë”© ì¤‘...</div>';
          popup.style.display = 'block';
          
          // ì‹¤ì œ ë°ì´í„° ë¡œë“œ
          loadWeatherData(city, port, date, content);
        } else {
          console.error('íŒì—… ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      }
    });
    
    // íŒì—… ë‹«ê¸° ê¸°ëŠ¥
    window.closeWeatherPopup = function() {
      const popup = document.getElementById('weather-popup');
      if (popup) {
        popup.style.display = 'none';
      }
    };
    
    // ESC í‚¤ë¡œ íŒì—… ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeWeatherPopup();
      }
    });
    
    // íŒì—… ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
    const popup = document.getElementById('weather-popup');
    if (popup) {
      popup.addEventListener('click', function(e) {
        if (e.target === this) {
          closeWeatherPopup();
        }
      });
    }
    
    // ë‚ ì”¨ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    async function loadWeatherData(city, port, date, contentEl) {
      try {
        const BADA_PORT_IDS = {
          'ë‚¨í•­(ì¸ì²œí•­)': 158, 'ì—°ì•ˆë¶€ë‘': 158, 'ì˜í¥í•­': 151, 'ì˜¤ì´ë„í•­': 380,
          'ì „ê³¡í•­': 618, 'í‰íƒí•­': 149, 'ì¥ê³ í•­': 370, 'ì‚¼ê¸¸í¬í•­': 144,
          'ë§ˆê²€í¬í•­': 1400, 'ëª¨í•­í•­': 134, 'ì˜ëª©í•­': 354, 'ì‹ ì§„ë„í•­': 965,
          'ì˜¤ì²œí•­': 355, 'êµ¬ë§¤í•­': 1385, 'ëŒ€ì²œí•­': 126, 'ë¬´ì°½í¬í•­': 236,
          'ë‚¨ë‹¹í•­': 356, 'í™ì›í•­': 523, 'ë¹„ì‘í•­': 118, 'ì•¼ë¯¸ë„í•­': 348,
          'ê²©í¬í•­': 430, 'ëŒì‚°í•­': 270, 'êµ­ë™í•­': 271, 'ì†Œí˜¸í•­': 826,
          'ì‹ ì¶”í•­': 885, 'ì¢…í¬í•­': 886, 'ë…¹ë™ë°©íŒŒì œ': 443
        };
        
        const portId = BADA_PORT_IDS[port];
        if (!portId) {
          throw new Error('í•´ë‹¹ í•­êµ¬ì˜ ë°”ë‹¤íƒ€ì„ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + port);
        }
        
        const response = await fetch('/api/tide?port_id=' + portId + '&date=' + date);
        if (!response.ok) {
          throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨: ' + response.status);
        }
        
        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }
        
        // ê°„ë‹¨í•œ í…Œì´ë¸” í‘œì‹œ
        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: #f9fafb;">';
        html += '<th style="padding: 12px; border: 1px solid #e5e7eb;">ì‹œê°„</th>';
        html += '<th style="padding: 12px; border: 1px solid #e5e7eb;">í’í–¥</th>';
        html += '<th style="padding: 12px; border: 1px solid #e5e7eb;">í’ì†</th>';
        html += '<th style="padding: 12px; border: 1px solid #e5e7eb;">ë‚ ì”¨</th>';
        html += '<th style="padding: 12px; border: 1px solid #e5e7eb;">ê¸°ì˜¨</th>';
        html += '<th style="padding: 12px; border: 1px solid #e5e7eb;">íŒŒê³ </th>';
        html += '</tr></thead><tbody>';
        
        if (data.data && data.data.length > 0) {
          data.data.forEach(function(row) {
            html += '<tr>';
            html += '<td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">' + (row.time || '') + '</td>';
            html += '<td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">' + (row.wind_dir || '') + '</td>';
            html += '<td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">' + (row.wind_speed || '') + '</td>';
            html += '<td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">' + (row.weather_text || '') + '</td>';
            html += '<td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">' + (row.temperature || '') + '</td>';
            html += '<td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">' + (row.wave_height || '') + '</td>';
            html += '</tr>';
          });
        } else {
          html += '<tr><td colspan="6" style="padding: 20px; text-align: center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        
        html += '</tbody></table>';
        contentEl.innerHTML = html;
        
      } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì—ëŸ¬:', error);
        contentEl.innerHTML = '<div style="padding: 20px; color: red; text-align: center;">ì—ëŸ¬: ' + error.message + '</div>';
      }
    }

    // ====== ì •ë ¬ ë™ì‘ ë¡œì§ (í–‰ ë‹¨ìœ„ë¡œ ë³€ê²½) ======
    const tbody = document.getElementById('results-body');
    const sortBtns = document.querySelectorAll('thead .sort-btn');
    if (!tbody) return;

    function parseRows() {
      const rows = [];
      for (const tr of Array.from(tbody.querySelectorAll('tr'))) {
        const tds = tr.querySelectorAll('td');
        if (tds.length < 8) continue;

        let i = 0;
        const city = tds[i++]?.textContent.trim() || '';
        const port = tds[i++]?.textContent.trim() || '';
        const registered_name = tds[i++]?.textContent.trim() || '';
        const fish = tds[i++]?.textContent.trim() || '';
        const ship_name = tds[i++]?.textContent.trim() || '';

        const statusTd = tds[i++];
        const statusBadge = statusTd?.querySelector('.status-badge');
        const status_text = statusBadge?.textContent.trim() || statusTd?.textContent.trim() || '';
        
        let status_class = 'unknown';
        if (statusBadge) {
          if (statusBadge.classList.contains('badge-available')) status_class = 'open';
          else if (statusBadge.classList.contains('badge-closed')) status_class = 'closed';
          else if (statusBadge.classList.contains('badge-maintenance')) status_class = 'maintenance';
        }

        const availText = tds[i++]?.textContent.trim() || '';
        const available = /^\d+$/.test(availText) ? parseInt(availText, 10) : null;

        const urlTd = tds[i++];
        const a = urlTd?.querySelector('a');
        const url = a ? a.getAttribute('href') : '';
        const url_path = a ? (a.textContent || '').trim() : '';

        rows.push({
          city, port, registered_name, fish, ship_name,
          status_text, status_class, available, url, url_path
        });
      }
      return rows;
    }

    function renderRows(rows) {
      const frag = document.createDocumentFragment();
      for (const r of rows) {
        const tr = document.createElement('tr');

        // ì§€ì—­
        const tdCity = document.createElement('td');
        tdCity.textContent = r.city;
        tr.appendChild(tdCity);

        // í•­êµ¬
        const tdPort = document.createElement('td');
        tdPort.textContent = r.port;
        tr.appendChild(tdPort);

        // ë“±ë¡ëœ ë°°
        const tdRN = document.createElement('td');
        tdRN.textContent = r.registered_name || '-';
        tr.appendChild(tdRN);

        // ì–´ì¢…
        const tdFish = document.createElement('td');
        tdFish.textContent = r.fish || '-';
        tr.appendChild(tdFish);

        // ë°° ì´ë¦„
        const tdShip = document.createElement('td');
        tdShip.style.fontWeight = '600';
        tdShip.textContent = r.ship_name || '-';
        tr.appendChild(tdShip);

        // ìƒíƒœ (badge ìŠ¤íƒ€ì¼ ì ìš©)
        const tdStatus = document.createElement('td');
        tdStatus.style.textAlign = 'center';
        const badge = document.createElement('span');
        badge.className = 'status-badge';
        
        if (r.status_class === 'open') {
          badge.classList.add('badge-available');
          badge.textContent = 'ì˜ˆì•½ê°€ëŠ¥';
        } else if (r.status_class === 'closed') {
          badge.classList.add('badge-closed');
          badge.textContent = 'ì˜ˆì•½ë§ˆê°';
        } else if (r.status_class === 'maintenance') {
          badge.classList.add('badge-maintenance');
          badge.textContent = 'ì ê²€ì¼';
        } else {
          badge.textContent = r.status_text || '-';
        }
        tdStatus.appendChild(badge);
        tr.appendChild(tdStatus);

        // ë‚¨ì€ìë¦¬
        const tdAvail = document.createElement('td');
        tdAvail.style.textAlign = 'center';
        tdAvail.textContent = (r.status_class === 'closed') ? '0' : (r.available != null ? String(r.available) : '-');
        tr.appendChild(tdAvail);

        // URL
        const tdUrl = document.createElement('td');
        if (r.url) {
          const link = document.createElement('a');
          link.href = r.url;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.style.cssText = 'color: #3b82f6; text-decoration: none;';
          link.textContent = 'URL ë§í¬';
          tdUrl.appendChild(link);
        } else {
          tdUrl.textContent = '-';
        }
        tr.appendChild(tdUrl);

        // ë‚ ì”¨/ë¬¼ë•Œ íŒì—…
        const tdWeather = document.createElement('td');
        tdWeather.style.textAlign = 'center';
        const popupBtn = document.createElement('button');
        popupBtn.className = 'btn-popup';
        popupBtn.textContent = 'íŒì—… ë³´ê¸°';
        popupBtn.setAttribute('data-city', r.city || '');
        popupBtn.setAttribute('data-port', r.port || '');
        
        // í˜„ì¬ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸° (ê²€ìƒ‰ëœ ë‚ ì§œ ì‚¬ìš©)
        const searchForm = document.getElementById('status-form');
        const year = searchForm ? searchForm.querySelector('input[name="year"]')?.value : new Date().getFullYear();
        const month = searchForm ? searchForm.querySelector('input[name="month"]')?.value : (new Date().getMonth() + 1);
        const day = searchForm ? searchForm.querySelector('input[name="day"]')?.value : new Date().getDate();
        const formattedDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        popupBtn.setAttribute('data-date', formattedDate);
        console.log('íŒì—… ë²„íŠ¼ ìƒì„±:', { city: r.city, port: r.port, date: formattedDate }); // ë””ë²„ê¹…ìš©
        tdWeather.appendChild(popupBtn);
        tr.appendChild(tdWeather);

        frag.appendChild(tr);
      }
      tbody.innerHTML = '';
      tbody.appendChild(frag);
    }

    function compareStr(a, b) {
      return (a || '').localeCompare((b || ''), 'ko');
    }
    function statusRank(s) {
      if (s === 'open') return 0;
      if (s === 'maintenance') return 1;
      if (s === 'closed') return 2;
      return 3;
    }

    function sortRows(rows, key, dir) {
      const asc = dir === 'asc' ? 1 : -1;
      return rows.sort((r1, r2) => {

        if (key === 'status') {
          return (statusRank(r1.status_class) - statusRank(r2.status_class)) * asc;
        }
        if (['city','port','registered_name','fish','ship_name'].includes(key)) {
          return compareStr(r1[key], r2[key]) * asc;
        }
        return 0;
      });
    }

    function handleSortClick(e) {
      const btn = e.currentTarget;
      const key = btn.dataset.sortKey;
      const dir = btn.dataset.dir || 'asc';
      if (!key) return;

      const rows = parseRows();
      sortRows(rows, key, dir);
      renderRows(rows);
    }

    sortBtns.forEach(b => b.addEventListener('click', handleSortClick));
    // ====== ì •ë ¬ ë¡œì§ ë ======
  });

  // ë‚ ì”¨/ë¬¼ë•Œ íŒì—… ê´€ë ¨ í•¨ìˆ˜ë“¤
  function getCurrentDate() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function openWeatherPopup(city, port, date) {
    console.log('openWeatherPopup í˜¸ì¶œë¨:', { city, port, date }); // ë””ë²„ê¹…ìš©
    const popup = document.getElementById('weather-popup');
    const title = document.getElementById('popup-title');
    const content = document.getElementById('popup-weather-content');
    
    if (!popup) {
      console.error('íŒì—… ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!');
      return;
    }
    
    title.textContent = port + ' ë‚ ì”¨/ë¬¼ë•Œ ì •ë³´ (' + date + ')';
    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">ë¡œë”© ì¤‘...</div>';
    popup.style.display = 'block';
    
    console.log('íŒì—… í‘œì‹œë¨'); // ë””ë²„ê¹…ìš©
    
    // ë°”ë‹¤íƒ€ì„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    fetchWeatherData(city, port, date, content);
  }

  function closeWeatherPopup() {
    document.getElementById('weather-popup').style.display = 'none';
  }

  async function fetchWeatherData(city, port, date, contentEl) {
    try {
      // views.pyì—ì„œ ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” get_bada_port_ids() ë§¤í•‘ ì‚¬ìš©
      const BADA_PORT_IDS = {
        'ë‚¨í•­(ì¸ì²œí•­)': 158,
        'ì—°ì•ˆë¶€ë‘': 158,
        'ì˜í¥í•­': 151,
        'ì˜¤ì´ë„í•­': 380,
        'ì „ê³¡í•­': 618,
        'í‰íƒí•­': 149,
        'ì¥ê³ í•­': 370,
        'ì‚¼ê¸¸í¬í•­': 144,
        'ë§ˆê²€í¬í•­': 1400,
        'ëª¨í•­í•­': 134,
        'ì˜ëª©í•­': 354,
        'ì‹ ì§„ë„í•­': 965,
        'ì˜¤ì²œí•­': 355,
        'êµ¬ë§¤í•­': 1385,
        'ëŒ€ì²œí•­': 126,
        'ë¬´ì°½í¬í•­': 236,
        'ë‚¨ë‹¹í•­': 356,
        'í™ì›í•­': 523,
        'ë¹„ì‘í•­': 118,
        'ì•¼ë¯¸ë„í•­': 348,
        'ê²©í¬í•­': 430,
        'ëŒì‚°í•­': 270,
        'êµ­ë™í•­': 271,
        'ì†Œí˜¸í•­': 826,
        'ì‹ ì¶”í•­': 885,
        'ì¢…í¬í•­': 886,
        'ë…¹ë™ë°©íŒŒì œ': 443
      };
      
      console.log('íŒì—… ë°ì´í„°:', { city, port, date }); // ë””ë²„ê¹…ìš©
      
      // í•­êµ¬ëª…ìœ¼ë¡œ ë°”ë‹¤íƒ€ì„ ID ì°¾ê¸°
      const portId = BADA_PORT_IDS[port];
      if (!portId) {
        console.error('í•­êµ¬ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', port, 'ì‚¬ìš© ê°€ëŠ¥í•œ í•­êµ¬:', Object.keys(BADA_PORT_IDS));
        contentEl.innerHTML = '<div style="padding: 20px; color: #ef4444;">í•´ë‹¹ í•­êµ¬(' + port + ')ì˜ ë‚ ì”¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ì‚¬ìš© ê°€ëŠ¥í•œ í•­êµ¬: ' + Object.keys(BADA_PORT_IDS).join(', ') + '</div>';
        return;
      }
      
      console.log('í¬íŠ¸ ID ì°¾ìŒ:', portId, 'for', port); // ë””ë²„ê¹…ìš©
      
      // ë‚ ì”¨ ë°ì´í„° API í˜¸ì¶œ
      console.log('API í˜¸ì¶œ:', '/api/tide?port_id=' + portId + '&date=' + date); // ë””ë²„ê¹…ìš©
      const qs = new URLSearchParams({ port_id: String(portId), date: date });
      const resp = await fetch('/api/tide?' + qs.toString());
      if (!resp.ok) {
        console.error('API ì‘ë‹µ ì—ëŸ¬:', resp.status, resp.statusText);
        throw new Error('ë‚ ì”¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (' + resp.status + ')');
      }
      
      const data = await resp.json();
      console.log('API ì‘ë‹µ ë°ì´í„°:', data); // ë””ë²„ê¹…ìš©
      if (data.error) throw new Error(data.error);
      
      // ê·¸ë˜í”„ ë°ì´í„°ë„ ê°€ì ¸ì˜¤ê¸°
      console.log('ê·¸ë˜í”„ API í˜¸ì¶œ:', '/api/tide_graph?port_id=' + portId + '&date=' + encodeURIComponent(date)); // ë””ë²„ê¹…ìš©
      const gresp = await fetch('/api/tide_graph?port_id=' + portId + '&date=' + encodeURIComponent(date));
      let graphHtml = '';
      if (gresp.ok) {
        const gdata = await gresp.json();
        console.log('ê·¸ë˜í”„ API ì‘ë‹µ:', gdata); // ë””ë²„ê¹…ìš©
        if (gdata.success) {
          graphHtml = (gdata.pc_html || '') + (gdata.chart_html || '');
          console.log('ê·¸ë˜í”„ HTML ê¸¸ì´:', graphHtml.length); // ë””ë²„ê¹…ìš©
          // ìŠ¤í¬ë¦½íŠ¸ëŠ” ë³µì¡í•˜ë¯€ë¡œ ë‚˜ì¤‘ì— ì²˜ë¦¬
        }
      } else {
        console.error('ê·¸ë˜í”„ API ì—ëŸ¬:', gresp.status, gresp.statusText);
      }
      
      // weather.htmlê³¼ ë™ì¼í•œ tide-result í…Œì´ë¸” í˜•íƒœë¡œ ìƒì„±
      const tideUrl = 'https://www.badatime.com/' + portId + '/tide/' + date;
      
      let resultHtml = '<div style="position: relative; width: 100%; max-width: 1200px; margin: 0 auto;">';
      
      // ê²°ê³¼ í—¤ë” (weather.htmlì˜ result-headerì™€ ë™ì¼)
      resultHtml += '<div style="background: linear-gradient(135deg, #06b6d4 0%, #0e7490 100%); color: #fff; padding: 15px 0; border-radius: 18px 18px 0 0; text-align: center;">';
      resultHtml += '<h2 style="margin: 0; font-size: 22px; font-weight: 700;">' + port + ' (' + date + ')</h2>';
      resultHtml += '<p style="margin: 0; font-size: 13px; opacity: 0.9;">' + date + ' Â· <a href="' + tideUrl + '" target="_blank" rel="noopener" style="color: #fff; text-decoration: underline;">' + tideUrl + '</a></p>';
      resultHtml += '</div>';
      
      // 2ì—´ ë ˆì´ì•„ì›ƒ ì‹œì‘ (weather.htmlì˜ result-splitê³¼ ë™ì¼)
      resultHtml += '<div style="display: flex; gap: 16px; background: #fff; border-radius: 0 0 18px 18px; box-shadow: 0 4px 18px rgba(0,0,0,.08); overflow: hidden; min-height: 600px;">';
      
      // ì¢Œì¸¡ í…Œì´ë¸” ì˜ì—­ (weather.htmlì˜ result-leftì™€ ë™ì¼)
      resultHtml += '<div style="flex: 1; min-width: 0; border-right: 1px solid #eef2f7; overflow: visible;">';
      resultHtml += '<table style="width: 100%; border-collapse: collapse;">';
      
      // í…Œì´ë¸” í—¤ë” (weather.htmlì˜ thead ìŠ¤íƒ€ì¼ê³¼ ë™ì¼)
      resultHtml += '<thead>';
      resultHtml += '<tr>';
      resultHtml += '<th style="background: #f9fafb; padding: 14px 10px; font-size: 16px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; text-align: center; letter-spacing: 0.5px;">ì‹œê°„</th>';
      resultHtml += '<th style="background: #f9fafb; padding: 14px 10px; font-size: 16px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; text-align: center; letter-spacing: 0.5px;">í’í–¥</th>';
      resultHtml += '<th style="background: #f9fafb; padding: 14px 10px; font-size: 16px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; text-align: center; letter-spacing: 0.5px;">í’ì†</th>';
      resultHtml += '<th style="background: #f9fafb; padding: 14px 10px; font-size: 16px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; text-align: center; letter-spacing: 0.5px;">ë‚ ì”¨</th>';
      resultHtml += '<th style="background: #f9fafb; padding: 14px 10px; font-size: 16px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; text-align: center; letter-spacing: 0.5px;">ê¸°ì˜¨</th>';
      resultHtml += '<th style="background: #f9fafb; padding: 14px 10px; font-size: 16px; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; text-align: center; letter-spacing: 0.5px;">íŒŒê³ /ì£¼ê¸°</th>';
      resultHtml += '</tr>';
      resultHtml += '</thead>';
      
      // í…Œì´ë¸” ë³¸ë¬¸
      resultHtml += '<tbody>';
      
      if (data.data && data.data.length > 0) {
        data.data.forEach((r, index) => {
          // weather.htmlì˜ renderTideRowsì™€ ë™ì¼í•œ ë¡œì§
          const weatherDisplay = r.weather_icon_url ? 
            '<img src="' + r.weather_icon_url + '" alt="" width="28" style="vertical-align:middle;margin-right:4px;">' + (r.weather_text||'') : 
            (r.weather_text||'');
          const windDirDisplay = r.wind_dir_icon_url ? 
            '<img src="' + r.wind_dir_icon_url + '" alt="" width="16" style="vertical-align:middle;margin-right:4px;">' + (r.wind_dir||'') : 
            (r.wind_dir||'');
          
          // weather.htmlê³¼ ë™ì¼í•œ í’ì† ìƒ‰ìƒ ì²˜ë¦¬
          let windSpeedColor = '#4b5563'; // ê¸°ë³¸ ìƒ‰ìƒ
          const windSpeed = parseFloat(r.wind_speed || '0');
          if (windSpeed >= 5.0 && windSpeed <= 7.9) {
            windSpeedColor = '#f1c40f'; // ë…¸ë€ìƒ‰
          } else if (windSpeed >= 8.0 && windSpeed <= 15.0) {
            windSpeedColor = '#c0392b'; // ë¹¨ê°„ìƒ‰
          }
          
          // weather.htmlì˜ tbody ìŠ¤íƒ€ì¼ê³¼ ë™ì¼ (í™€ì§ ë°°ê²½, í˜¸ë²„ ë“±)
          const bgColor = (index % 2 === 0) ? '#fff' : '#f9fafb';
          
          resultHtml += '<tr style="background: ' + bgColor + ';" onmouseover="this.style.background=\'#f3f4f6\'" onmouseout="this.style.background=\'' + bgColor + '\'">';
          resultHtml += '<td style="padding: 14px 10px; border-bottom: 1px solid #f3f4f6; font-size: 15px; color: #111827; text-align: center; font-weight: 600;">' + (r.time || '') + '</td>'; // time-cell í´ë˜ìŠ¤ ìŠ¤íƒ€ì¼
          resultHtml += '<td style="padding: 14px 10px; border-bottom: 1px solid #f3f4f6; font-size: 15px; color: #4b5563; text-align: center;">' + windDirDisplay + '</td>';
          resultHtml += '<td style="padding: 14px 10px; border-bottom: 1px solid #f3f4f6; font-size: 15px; text-align: center; color: ' + windSpeedColor + ';">' + (r.wind_speed || '') + '</td>';
          resultHtml += '<td style="padding: 14px 10px; border-bottom: 1px solid #f3f4f6; font-size: 15px; color: #4b5563; text-align: center;">' + weatherDisplay + '</td>';
          resultHtml += '<td style="padding: 14px 10px; border-bottom: 1px solid #f3f4f6; font-size: 15px; color: #4b5563; text-align: center;">' + (r.temperature || '') + '</td>';
          resultHtml += '<td style="padding: 14px 10px; border-bottom: 1px solid #f3f4f6; font-size: 15px; color: #4b5563; text-align: center;">' + (r.wave_height || '') + '</td>';
          resultHtml += '</tr>';
        });
      } else {
        resultHtml += '<tr class="empty-row"><td colspan="6" style="padding: 42px; font-size: 14px; color: #9ca3af; text-align: center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      }
      
      resultHtml += '</tbody>';
      resultHtml += '</table>';
      resultHtml += '</div>';
      
      // ìš°ì¸¡ ê·¸ë˜í”„ ì˜ì—­ (weather.htmlì˜ result-rightì™€ ë™ì¼)
      resultHtml += '<div style="flex: 1; min-width: 0; background: #fff; overflow: visible;">';
      resultHtml += '<div style="padding: 8px; background: #fff; height: 600px; overflow: visible;">';
      resultHtml += graphHtml || '<div style="padding: 20px; color: #6b7280; text-align: center;">ê·¸ë˜í”„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
      resultHtml += '</div>';
      resultHtml += '</div>';
      
      resultHtml += '</div>'; // result-split ì¢…ë£Œ
      resultHtml += '</div>'; // ì „ì²´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
      
      contentEl.innerHTML = resultHtml;
      
    } catch (error) {
      console.error('fetchWeatherData ì—ëŸ¬:', error); // ë””ë²„ê¹…ìš©
      contentEl.innerHTML = '<div style="padding: 20px; color: #ef4444; text-align: center;">ì—ëŸ¬: ' + error.message + '<br><br>ë””ë²„ê·¸ ì •ë³´:<br>ë„ì‹œ: ' + city + ', í•­êµ¬: ' + port + ', ë‚ ì§œ: ' + date + '</div>';
    }
  }

  // íŒì—… ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ìœ„ì„
  document.addEventListener('click', function(e) {
    console.log('í´ë¦­ ì´ë²¤íŠ¸:', e.target, 'class:', e.target.className); // ë””ë²„ê¹…ìš©
    if (e.target.classList.contains('btn-popup')) {
      console.log('íŒì—… ë²„íŠ¼ í´ë¦­ë¨!'); // ë””ë²„ê¹…ìš©
      const city = e.target.getAttribute('data-city');
      const port = e.target.getAttribute('data-port');
      const date = e.target.getAttribute('data-date');
      console.log('íŒì—… ë°ì´í„°:', { city, port, date }); // ë””ë²„ê¹…ìš©
      openWeatherPopup(city, port, date);
    }
  });

  // ESC í‚¤ë¡œ íŒì—… ë‹«ê¸°
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeWeatherPopup();
    }
  });

  // íŒì—… ë°°ê²½ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
  document.getElementById('weather-popup').addEventListener('click', function(e) {
    if (e.target === this) {
      closeWeatherPopup();
    }
  });
</script>

<!-- ë‚ ì”¨/ë¬¼ë•Œ íŒì—… ëª¨ë‹¬ -->
<div id="weather-popup" class="weather-popup">
  <div class="popup-content">
    <div class="popup-header">
      <h3 id="popup-title">ë‚ ì”¨/ë¬¼ë•Œ ì •ë³´</h3>
      <button type="button" class="popup-close" onclick="closeWeatherPopup()">&times;</button>
    </div>
    <div class="popup-body">
      <div id="popup-weather-content">
        <div style="text-align: center; padding: 40px; color: #6b7280;">
          ë¡œë”© ì¤‘...
        </div>
      </div>
    </div>
  </div>
</div>

<!-- amCharts v4 ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ (ê·¸ë˜í”„ ë Œë”ë§ìš©) -->
<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
<script src="https://cdn.amcharts.com/lib/4/lang/ko_KR.js"></script>

{% endblock %}