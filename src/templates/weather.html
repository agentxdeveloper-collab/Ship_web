{% extends "base.html" %}
{% block content %}
<style>
  .tide-container{max-width:1200px;margin:24px auto;padding:0 12px}
  .tide-card{background:#fff;border-radius:18px;box-shadow:0 4px 18px rgba(0,0,0,.08);padding:28px;margin-bottom:28px}
  .tide-title{font-size:22px;font-weight:700;margin:0 0 18px;color:#1f2937}
  .tide-form{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end}
  .tide-form .form-group{flex:1;min-width:180px}
  .form-group label{display:block;font-size:16px;font-weight:700;color:#374151;margin-bottom:6px}
  /* Reuse register form-control, but larger for weather */
  .tide-form .form-control{width:100%;padding:12px 16px;border:1px solid #d1d5db;border-radius:8px;font-size:22px;box-sizing:border-box}
  .btn-fetch{padding:14px 32px;background:#0d9488;color:#fff;font-weight:700;font-size:18px;border:none;border-radius:8px;cursor:pointer}
  .btn-fetch:hover{background:#0f766e}
  .result-header{background:linear-gradient(135deg,#06b6d4 0%,#0e7490 100%);color:#fff;padding:20px;border-radius:18px 18px 0 0;text-align:center}
  .result-header h2{margin:0;font-size:22px;font-weight:700}
  .result-header p{margin:6px 0 0;font-size:13px;opacity:.9}
  table{width:100%;border-collapse:collapse}
  thead th{background:#f9fafb;padding:14px 10px;font-size:12px;font-weight:600;color:#374151;border-bottom:2px solid #e5e7eb;text-align:center;letter-spacing:.5px}
  tbody td{padding:14px 10px;border-bottom:1px solid #f3f4f6;font-size:13px;color:#4b5563;text-align:center}
  tbody tr:nth-child(even){background:#f9fafb}
  tbody tr:hover{background:#f3f4f6}
  .time-cell{font-weight:600;color:#111827;font-size:15px}
  .status-box{margin-top:4px;font-size:11px;color:#6b7280}
  .loading-row td{padding:42px;font-size:14px;color:#6b7280}
  .empty-row td{padding:42px;font-size:14px;color:#9ca3af}
  .note{margin-top:10px;font-size:12px;color:#64748b}

  /* Flatpickr sizing + Korean style tweaks */
  .fp-wrap{position:relative;display:flex;align-items:center;gap:8px}
  .calendar-btn{display:inline-flex;align-items:center;justify-content:center;width:48px;height:48px;border:1px solid #d1d5db;border-radius:8px;background:#fff;cursor:pointer}
  .calendar-btn svg{width:28px;height:28px;color:#374151}
  .date-input{height:48px}
  .flatpickr-calendar{font-size:16px}
  .flatpickr-months .flatpickr-month{height:48px}
  .flatpickr-day{width:42px;height:36px;line-height:36px}
</style>

<div class="tide-container">
  <div class="tide-card">
    <h2 class="tide-title">ğŸŒŠ ë°”ë‹¤íƒ€ì„ í•­êµ¬ Tide/ë‚ ì”¨ ì¡°íšŒ</h2>
    <form id="tide-form" class="tide-form">
      <div class="form-group">
        <label class="form-label" for="city">ì§€ì—­ ì„ íƒ</label>
        <select id="city" class="form-control" required>
          <option value="">ì§€ì—­ ì„ íƒ</option>
          {% for city in city_port_mapping.keys() %}
            <option value="{{ city }}">{{ city }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="port">í•­êµ¬ ì„ íƒ</label>
        <select id="port" class="form-control" required disabled>
          <option value="">ì§€ì—­ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="date">ë‚ ì§œ</label>
        <div class="fp-wrap">
          <input id="date" class="form-control date-input" type="text" placeholder="YYYY-MM-DD" required />
          <button type="button" id="open-cal" class="calendar-btn" aria-label="ë‹¬ë ¥ ì—´ê¸°">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2"></rect>
              <path d="M16 2v4M8 2v4M3 10h18"></path>
            </svg>
          </button>
        </div>
      </div>
      <button type="submit" class="btn-fetch">ì¡°íšŒ</button>
    </form>
    <p class="note">â€» ë°”ë‹¤íƒ€ì„ week_containerë¥¼ íŒŒì‹±í•˜ì—¬ ì‹œê°„í‘œë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤. í•­êµ¬ë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ port_idë¥¼ ë§¤í•‘í•˜ì—¬ ì¡°íšŒí•©ë‹ˆë‹¤.</p>
  </div>

  <div id="tide-result" style="display:none;">
    <div class="result-header">
      <h2 id="result-title">í•­êµ¬ ë²ˆí˜¸ -</h2>
      <p id="result-sub">ì›ë³¸: -</p>
    </div>
    <div class="tide-table-wrapper" style="background:#fff;border-radius:0 0 18px 18px;box-shadow:0 4px 18px rgba(0,0,0,.08);overflow:hidden;">
      <table id="tide-table">
        <thead>
          <tr>
            <th>ì‹œê°„</th>
            <th>í’í–¥</th>
            <th>í’ì†</th>
            <th>ë‚ ì”¨</th>
            <th>ê¸°ì˜¨</th>
            <th>íŒŒê³ /ì£¼ê¸°</th>
          </tr>
        </thead>
        <tbody id="tide-tbody">
          <tr class="loading-row"><td colspan="6">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Flatpickr CDN (modern datepicker) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/ko.js"></script>

<script>
// í…œí”Œë¦¿ ë°ì´í„°
const CITY_PORTS = {{ city_port_mapping | tojson | safe }};
const BADA_PORT_IDS = {{ bada_port_ids | tojson | safe }};

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('tide-form');
  const tbody = document.getElementById('tide-tbody');
  const resultWrap = document.getElementById('tide-result');
  const titleEl = document.getElementById('result-title');
  const subEl = document.getElementById('result-sub');
  const dateEl = document.getElementById('date');
  const openBtn = document.getElementById('open-cal');

  // Flatpickr init: yyyy-mm-dd, Korean weekdays, today default
  const fp = flatpickr(dateEl, {
    dateFormat: 'Y-m-d',
    defaultDate: new Date(),
    locale: flatpickr.l10ns.ko,
    allowInput: true,
    disableMobile: true
  });
  openBtn.addEventListener('click', () => fp.open());

  // ì§€ì—­ ë³€ê²½ ì‹œ í•­êµ¬ ëª©ë¡ ì±„ìš°ê¸°
  const citySel = document.getElementById('city');
  const portSel = document.getElementById('port');
  citySel.addEventListener('change', () => {
    const city = citySel.value;
    portSel.innerHTML = '';
    if (city && CITY_PORTS[city]) {
      portSel.disabled = false;
      CITY_PORTS[city].forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        portSel.appendChild(opt);
      });
    } else {
      portSel.disabled = true;
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'ì§€ì—­ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”';
      portSel.appendChild(opt);
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const portName = portSel.value;
    if(!portName){
      alert('í•­êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    const portId = BADA_PORT_IDS[portName];
    if(!portId){
      alert('ì„ íƒí•œ í•­êµ¬ì˜ badatime IDê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    const dateStr = dateEl.value; // YYYY-MM-DD
    resultWrap.style.display = 'block';
    titleEl.textContent = `${portName} (ID ${portId})`;
    subEl.textContent = dateStr || 'ìš”ì²­ ì¤‘...';
    tbody.innerHTML = '<tr class="loading-row"><td colspan="6">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
    try {
      const qs = new URLSearchParams({ port_id: String(portId), date: dateStr || '' });
      const resp = await fetch(`/api/tide?${qs.toString()}`);
      if(!resp.ok) throw new Error('ìš”ì²­ ì‹¤íŒ¨');
      const data = await resp.json();
      if(data.error){
        throw new Error(data.error);
      }
      subEl.textContent = (dateStr ? `${dateStr} Â· ` : '') + (data.source_url || 'ì›ë³¸ URL ì •ë³´ ì—†ìŒ');
      renderTideRows(data.data || []);
    } catch(err){
      console.error(err);
      tbody.innerHTML = `<tr class='empty-row'><td colspan='6'>ì˜¤ë¥˜: ${err.message}</td></tr>`;
      subEl.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
    }
  });

  function renderTideRows(rows){
    tbody.innerHTML = '';
    if(!rows.length){
      tbody.innerHTML = '<tr class="empty-row"><td colspan="6">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      return;
    }
    rows.forEach(r => {
      const tr = document.createElement('tr');
      const weatherDisplay = r.weather_icon_url ? `<img src='${r.weather_icon_url}' alt='' width='28' style='vertical-align:middle;margin-right:4px;'>${r.weather_text||''}` : (r.weather_text||'');
      const windDirDisplay = r.wind_dir_icon_url ? `<img src='${r.wind_dir_icon_url}' alt='' width='16' style='vertical-align:middle;margin-right:4px;'>${r.wind_dir||''}` : (r.wind_dir||'');
      tr.innerHTML = `
        <td class='time-cell'>${r.time || ''}</td>
        <td>${windDirDisplay}</td>
        <td>${r.wind_speed || ''}</td>
        <td>${weatherDisplay}</td>
        <td>${r.temperature || ''}</td>
        <td>${r.wave_height || ''}</td>`;
      tbody.appendChild(tr);
    });
  }
});
</script>
{% endblock %}
